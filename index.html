<!doctype html>
<html lang="de" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="color-scheme" content="light dark">
<title>Pendler Dashboard</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Pendler Dashboard">

<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="alternate icon" type="image/png" sizes="512x512" href="apple-touch-icon.png">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
<link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Pull-to-Refresh indicator (hidden until pulling) -->
  </div>

  <!-- Topbar -->
  <div class="tabs">
    <button id="menuBtn" class="hamburger pressy" aria-label="Menü öffnen" aria-expanded="false">
      <i class="fa-solid fa-bars"></i> Menü
    </button>

    <div id="tabsInline" class="left" role="tablist" aria-label="Navigation">
      <a href="#route-a" class="tab pressy active">Gießen → Frankfurt(Main) Hbf</a>
      <a href="#route-b" class="tab pressy">Frankfurt(Main) Hbf → Gießen</a>
      <a href="#abfahrten" class="tab pressy">Abfahrten (stadt­einwärts)</a>
      <a href="#homebound" class="tab pressy">Abfahrten (heimwärts)</a>
      <span id="tabIndicator" class="tab-indicator"></span>
    </div>

    <div class="spacer"></div>

    <button id="themeBtn" class="theme-btn pressy" aria-label="Theme umschalten">
      <i class="fa-solid fa-sun" id="sunIcon"></i>
      <i class="fa-solid fa-moon" id="moonIcon" style="display:none"></i>
    </button>
  </div>

  <!-- Drawer -->
  <div id="drawer" class="drawer" hidden>
    <div id="drawerBackdrop" class="drawer-backdrop" role="button" aria-label="Menü schließen"></div>
    <nav class="drawer-panel" aria-label="Menü">
      <a href="#route-a" class="tab" data-drawer-link>Gießen → Frankfurt(Main) Hbf</a>
      <a href="#route-b" class="tab" data-drawer-link>Frankfurt(Main) Hbf → Gießen</a>
      <a href="#abfahrten" class="tab" data-drawer-link>Abfahrten (stadt­einwärts)</a>
      <a href="#homebound" class="tab" data-drawer-link>Abfahrten (heimwärts)</a>
      <button id="drawerClose" class="btn pressy" style="margin-top:8px"><i class="fa-solid fa-xmark"></i> Schließen</button>
    </nav>
  </div>

  <div class="wrap">

    <!-- ROUTEN -->
    <div id="view-route" hidden>
      <div id="cards" class="cards"><div class="card">Lade Verbindungen …</div></div>
      <div class="more-wrap">
        <button id="moreBtn" class="btn pressy">Weitere Verbindungen (+60 min)</button>
        <span id="moreInfo" class="badge"></span>
      </div>
      <div id="noJourneys" class="hint" style="display:none">Für das gewählte Zeitfenster sind keine Verbindungen verfügbar.</div>
    </div>

    <!-- ABFAHRTEN STADTEINWÄRTS -->
    <div id="view-abfahrten" class="panel-table" hidden>
      <div class="table-head">
        <div><i class="fa-solid fa-clock"></i> Abfahrt</div>
        <div class="col-plan"><i class="fa-regular fa-calendar"></i> Plan</div>
        <div><i class="fa-solid fa-train"></i> Linie</div>
        <div><i class="fa-solid fa-location-dot"></i> Ziel</div>
        <div class="col-steig"><i class="fa-solid fa-signs-post"></i> Steig</div>
        <div><i class="fa-solid fa-clock-rotate-left"></i> +-</div>
      </div>
      <div id="rows" class="rows"><div style="padding:16px;color:var(--muted)">Lade Abfahrten …</div></div>
    </div>

    <!-- ABFAHRTEN HEIMWÄRTS -->
    <div id="view-homebound" class="panel-table" hidden>
      <div class="table-head">
        <div><i class="fa-solid fa-clock"></i> Abfahrt</div>
        <div class="col-plan"><i class="fa-regular fa-calendar"></i> Plan</div>
        <div><i class="fa-solid fa-location-dot"></i> Haltestelle</div>
        <div><i class="fa-solid fa-train"></i> Linie</div>
        <div class="col-steig"><i class="fa-solid fa-signs-post"></i> Steig</div>
        <div><i class="fa-solid fa-clock-rotate-left"></i> +-</div>
      </div>
      <div id="rows-home" class="rows"><div style="padding:16px;color:var(--muted)">Lade Abfahrten …</div></div>
    </div>

    <div class="footer">
      <span id="refreshInfo">Aktualisierung: —</span>
      <span style="margin:0 8px; opacity:.6">•</span>
      <span id="lastUpdated">Zuletzt: —</span>
    </div>
    <div class="footer-space"></div>
  </div>

<script>
/* ========= Config ========= */
const API='https://v6.db.transport.rest';
const Q_SCHOOL='Sophie-Scholl-Schule Gießen', Q_FFMHBF='Frankfurt(Main) Hbf', Q_FRIEDR='Friedrichstraße Gießen', Q_GIESSEN='Gießen Bahnhof';
const REFRESH_ROUTE_MS=60000, REFRESH_DEPS_MS=30000;
const EXCLUDE_DIRECTIONS=[/rödgen/i,/coleman\s*str/i];

let ids={school:null,ffm:null,friedr:null,giessenBhf:null};
let activeTab='route-a', timer=null, lastUpdated=null;

/* Routen-Mehr */
let routeLongMode=false;
let routeWindowMin=60;

/* ========= Theme ========= */
const mediaDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
const sunIcon=document.getElementById('sunIcon'), moonIcon=document.getElementById('moonIcon'), themeBtn=document.getElementById('themeBtn');
function applyTheme(m){
  document.documentElement.setAttribute('data-theme',m);
  if(m==='dark'){sunIcon.style.display='none';moonIcon.style.display='inline-block'}
  else {moonIcon.style.display='none';sunIcon.style.display='inline-block'}
  document.body.classList.add('theme-fade');
  setTimeout(()=>document.body.classList.remove('theme-fade'), 300);
  queueMicrotask(updateTabIndicator);
}
applyTheme(mediaDark?.matches?'dark':'light');
mediaDark?.addEventListener?.('change',e=>applyTheme(e.matches?'dark':'light'));
themeBtn.addEventListener('click',()=>applyTheme((document.documentElement.getAttribute('data-theme')==='light')?'dark':'light'));

/* ========= Drawer with subtle overshoot ========= */
const drawer=document.getElementById('drawer');
const menuBtn=document.getElementById('menuBtn');
const drawerBackdrop=document.getElementById('drawerBackdrop');
const drawerClose=document.getElementById('drawerClose');
function openDrawer(){ 
  drawer.hidden=false; 
  requestAnimationFrame(()=>{
    drawer.classList.add('open');
    const panel=drawer.querySelector('.drawer-panel');
    if(panel && !window.matchMedia('(prefers-reduced-motion: reduce)').matches){
      panel.animate(
        [{ transform:'translateX(-104%)' }, { transform:'translateX(0)' }, { transform:'translateX(-8px)' }, { transform:'translateX(0)' }],
        { duration:360, easing:'cubic-bezier(.2,.8,.2,1)' }
      );
    }
  });
  menuBtn.setAttribute('aria-expanded','true'); 
  document.body.classList.add('drawer-open');
  const h=document.querySelector('.tabs')?.offsetHeight||0; 
  const panel=drawer.querySelector('.drawer-panel');
  if(panel) panel.style.paddingTop=(h+16)+'px'; 
}
function closeDrawer(){ 
  const panel=drawer.querySelector('.drawer-panel');
  if(panel && !window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    panel.animate(
      [{ transform:'translateX(0)' }, { transform:'translateX(6px)' }, { transform:'translateX(-104%)' }],
      { duration:280, easing:'cubic-bezier(.2,.8,.2,1)' }
    );
  }
  drawer.classList.remove('open'); 
  menuBtn.setAttribute('aria-expanded','false'); 
  document.body.classList.remove('drawer-open'); 
  setTimeout(()=>{ drawer.hidden=true; }, 260);
}
menuBtn.addEventListener('click', ()=> (drawer.hidden?openDrawer():closeDrawer()));
drawerBackdrop.addEventListener('click', closeDrawer);
drawerClose.addEventListener('click', closeDrawer);
drawer.addEventListener('keydown', e=>{ if(e.key==='Escape') closeDrawer(); });
drawer.querySelectorAll('[data-drawer-link]').forEach(a=>a.addEventListener('click', ()=>{ closeDrawer(); setTimeout(()=>handleHash(), 0); }));

/* ========= Motion helpers ========= */
const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
function animateStagger(selector){
  if(prefersReduced) return;
  const items = document.querySelectorAll(selector);
  let i=0;
  for(const el of items){
    el.animate(
      [{ opacity:0, transform:'translateY(6px) scale(0.996)' },{ opacity:1, transform:'translateY(0) scale(1)' }],
      { duration:320, easing:'cubic-bezier(.2,.8,.2,1)', delay: i*30, fill:'both' }
    );
    i++;
  }
}
/* Springy press feedback */
function addSpringyPress(root=document){
  if(prefersReduced) return;
  root.querySelectorAll('.pressy, .btn').forEach(el=>{
    el.addEventListener('pointerdown', e=>{
      if(e.button!==0) return;
      el.setPointerCapture?.(e.pointerId);
      el.animate(
        [{ transform:'scale(1)' }, { transform:'scale(0.985)' }],
        { duration:90, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards' }
      );
    });
    const up=()=>{
      el.getAnimations().forEach(a=>a.cancel());
      el.animate(
        [{ transform:'scale(0.985)' }, { transform:'scale(1.012)' }, { transform:'scale(1)' }],
        { duration:220, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards' }
      );
    };
    el.addEventListener('pointerup', up);
    el.addEventListener('pointercancel', up);
    el.addEventListener('pointerleave', up);
  });
}
addSpringyPress();

/* ========= Dynamic Tab Underline ========= */
const tabsInline=document.getElementById('tabsInline');
const tabIndicator=document.getElementById('tabIndicator');
function updateTabIndicator(){
  if(!tabsInline || !tabIndicator) return;
  const act=tabsInline.querySelector('.tab.active');
  if(!act || getComputedStyle(tabsInline).display==='none'){
    tabIndicator.style.transform='translateX(0) scaleX(0)';
    tabIndicator.style.opacity='0';
    return;
  }
  const parentRect=tabsInline.getBoundingClientRect();
  const rect=act.getBoundingClientRect();
  const x = rect.left - parentRect.left;
  tabIndicator.style.opacity='1';
  tabIndicator.style.width = rect.width + 'px';
  tabIndicator.style.transform='translateX('+x+'px)';
}
new ResizeObserver(updateTabIndicator).observe(document.body);
window.addEventListener('resize', updateTabIndicator);
window.addEventListener('load', updateTabIndicator);

/* PTR removed per request: touch-based pull-to-refresh disabled */
/* ========= Helpers ========= */
const fmtHM = d => new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
const fmtHMS= d => new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
function isoDurToHuman(iso,dep,arr){
  if(iso){ const h=(iso.match(/(\d+)H/)||[])[1]|0, m=(iso.match(/(\d+)M/)||[])[1]|0; return (h?`${h} h `:'')+String(m).padStart(2,'0')+' min'; }
  if(dep&&arr){ const diff=Math.max(0,Math.round((new Date(arr)-new Date(dep))/60000)); const h=Math.floor(diff/60), m=diff%60; return (h?`${h} h `:'')+String(m).padStart(2,'0')+' min'; }
  return '–';
}
function setFooter(ms){
  document.getElementById('refreshInfo').textContent='Aktualisierung: alle '+Math.round(ms/1000)+' s';
  document.getElementById('lastUpdated').textContent='Zuletzt: '+(lastUpdated?fmtHMS(lastUpdated):'—');
}
async function fetchJSON(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error(`${url} → ${r.status}`);
  lastUpdated=Date.now(); setFooter((activeTab==='abfahrten'||activeTab==='homebound')?REFRESH_DEPS_MS:REFRESH_ROUTE_MS);
  return r.json();
}
async function findStopId(q,rx){
  const data=await fetchJSON(`${API}/locations?query=${encodeURIComponent(q)}&results=10&stops=true`);
  if(rx){const hit=data.find(x=>(x.type==='stop'||x.type==='station') && rx.test((x.name||'')+' '+(x.address?.city||''))); if(hit) return hit.id}
  const first=data.find(x=>x.type==='stop'||x.type==='station'); return first?.id||null;
}

/* ========= Linienfarben / Icons ========= */
const FIXED_COLORS={'Bus 1':'#3498db','1':'#3498db','Bus 17':'#e67e22','17':'#e67e22','RB40':'#9b59b6','RB41':'#1abc9c','RE30':'#f1c40f','S6':'#2ecc71','ICE':'#2c3e50','IC':'#34495e'};
const HUES=[168,145,204,282,48,28,6,210,320,260,100,36,14,190,230,75];
function hashLine(s){let h=0; for(const ch of String(s)) h=((h<<5)-h)+ch.charCodeAt(0),h|=0; return Math.abs(h)}
function lineColor(name){ if(!name) return '#7f8c8d'; const key=String(name).trim(); if(FIXED_COLORS[key]) return FIXED_COLORS[key]; const norm=key.replace(/\s+Richtung.*/i,'').trim(); if(FIXED_COLORS[norm]) return FIXED_COLORS[norm]; const hue=HUES[hashLine(key)%HUES.length]; const dark=(document.documentElement.getAttribute('data-theme')==='dark'); return `hsl(${hue} 78% ${dark?72:36}%)` }
function iconForProduct(p,m){p=(p||'').toLowerCase(); m=(m||'').toLowerCase(); if(p.includes('bus')||m==='bus')return'<i class="fa-solid fa-bus"></i>'; if(p.includes('suburban')||p.includes('s-bahn')||m==='subway')return'<i class="fa-solid fa-train-subway"></i>'; if(p.includes('tram'))return'<i class="fa-solid fa-train-tram"></i>'; return'<i class="fa-solid fa-train"></i>'}
function prettyStop(n){return n==='Gießen'?'Gießen Bahnhof':n}

/* ========= Timeline ========= */
function buildTimeline(legs){
  if(!legs?.length) return '';
  
  function plannedIfDiff(actual, planned){
    if(!actual || !planned) return '';
    const a=new Date(actual), p=new Date(planned);
    const diff=Math.round((a-p)/60000);
    return diff!==0 ? ` <span class="planned">(${fmtHM(planned)})</span>` : '';
  }
  function timeClass(actual, planned){
    if(!actual||!planned) return '';
    const m=Math.round((new Date(actual)-new Date(planned))/60000);
    return m>0?'late':(m<0?'early':'');
  }
  function rowTimeCell(arr, parr, dep, pdep){
    function sameMinute(a,b){
      if(!a||!b) return false;
      const A=new Date(a), B=new Date(b);
      return A.getHours()===B.getHours() && A.getMinutes()===B.getMinutes();
    }
    if(arr && dep && sameMinute(arr,dep)){
      const cls=timeClass(arr,parr);
      return `<div class="t-time ${cls}"><span class="actual">${fmtHM(arr)}</span>${plannedIfDiff(arr,parr)}</div>`;
    }
    let bits=[];
    if(arr){
      const cls=timeClass(arr,parr);
      bits.push(`<div class="t-time ${cls}"><span class="label">An</span><span class="actual">${fmtHM(arr)}</span>${plannedIfDiff(arr,parr)}</div>`);
    }
    if(dep){
      const cls=timeClass(dep,pdep);
      bits.push(`<div class="t-time ${cls}"><span class="label">Ab</span><span class="actual">${fmtHM(dep)}</span>${plannedIfDiff(dep,pdep)}</div>`);
    }
    if(bits.length===0) bits.push(`<div class="t-time">—</div>`);
    return bits.join('');
  }
    if(arr && dep && sameMinute(arr,dep)){
      const cls=timeClass(arr,parr);
      return `<div class="t-time ${cls}"><span class="actual">${fmtHM(arr)}</span>${plannedIfDiff(arr,parr)}</div>`;
    }
    let bits=[];
    if(arr){
      const cls=timeClass(arr,parr);
      bits.push(`<div class="t-time ${cls}">An <span class="actual">${fmtHM(arr)}</span>${plannedIfDiff(arr,parr)}</div>`);
    }
    if(dep){
      const cls=timeClass(dep,pdep);
      bits.push(`<div class="t-time ${cls}">Ab <span class="actual">${fmtHM(dep)}</span>${plannedIfDiff(dep,pdep)}</div>`);
    }
    if(bits.length===0) bits.push(`<div class="t-time">—</div>`);
    return bits.join('');
  }

  function uniqueStopsFromLegs(legs){
    // prefer stopovers if present for granular station/platforms
    const rows=[];
    for(const leg of legs){
      const sv = Array.isArray(leg.stopovers) ? leg.stopovers : [];
      if(sv.length){
        for(const so of sv){
          rows.push({
            key:`${so.stop?.name||''}|${so.arrival||''}|${so.departure||''}`,
            name: so.stop?.name || '—',
            arr: so.arrival || null,
            parr: so.plannedArrival || null,
            dep: so.departure || null,
            pdep: so.plannedDeparture || null,
            platform: so.prognosedPlatform || so.platform || so.plannedPlatform || '—'
          });
        }
      }else{
        // fallback to leg endpoints
        rows.push({
          key:`${leg.origin?.name||''}|${leg.departure||''}`,
          name: leg.origin?.name || '—',
          arr: null, parr: null,
          dep: leg.departure || null, pdep: leg.plannedDeparture || null,
          platform: leg.prognosedPlatform || leg.departurePlatform || leg.plannedDeparturePlatform || '—'
        });
        rows.push({
          key:`${leg.destination?.name||''}|${leg.arrival||''}`,
          name: leg.destination?.name || '—',
          arr: leg.arrival || null, parr: leg.plannedArrival || null,
          dep: null, pdep: null,
          platform: leg.prognosedPlatform || leg.arrivalPlatform || leg.plannedArrivalPlatform || '—'
        });
      }
    }
    // merge consecutive duplicates by name and minute
    const merged=[];
    for(const r of rows){
      const last=merged[merged.length-1];
      if(last && last.name===r.name){
        last.arr = last.arr || r.arr;
        last.parr = last.parr || r.parr;
        last.dep = last.dep || r.dep;
        last.pdep = last.pdep || r.pdep;
        last.platform = last.platform !== '—' ? last.platform : r.platform;
      }else{
        merged.push({...r});
      }
    }
    // remove exact duplicates
    const out=[]; const seen=new Set();
    for(const r of merged){
      if(seen.has(r.key)) continue;
      seen.add(r.key); out.push(r);
    }
    return out;
  }

  function setProgress(trackCol){
    // Compute a live progress bar height based on now between first dep and last arr
    try{
      const dots = $$('.t-track .dot', stopGrid);
      if(!dots.length) return;
      const first=dots[0].getBoundingClientRect();
      const last=dots[dots.length-1].getBoundingClientRect();
      const top=first.top + first.height/2 + window.scrollY;
      const bottom=last.top + last.height/2 + window.scrollY;
      const total = Math.max(4, bottom - top);
      const depISO = stopGrid.dataset.dep;
      const arrISO = stopGrid.dataset.arr;
      if(!depISO || !arrISO) return;
      const now = Date.now();
      const t0 = new Date(depISO).getTime();
      const t1 = new Date(arrISO).getTime();
      const ratio = Math.min(1, Math.max(0, (now - t0) / Math.max(1, t1 - t0)));
      const h = Math.round(total * ratio);
      const prog = $('.t-track .progress', stopGrid); // first progress element
      if(prog){
        prog.style.height = h + 'px';
      }
    }catch(e){ /* ignore */ }
  }

  function buildStops(legs){
    const rows = uniqueStopsFromLegs(legs);
    // clear previous
    stopGrid.querySelectorAll('.row').forEach(n=>n.remove());
    // data attributes for progress
    const dep = legs?.[0]?.departure || legs?.[0]?.plannedDeparture || '';
    const arr = legs?.[legs.length-1]?.arrival || legs?.[legs.length-1]?.plannedArrival || '';
    stopGrid.dataset.dep = dep;
    stopGrid.dataset.arr = arr;

    let html = '';
    rows.forEach((r,i)=>{
      html += `<div class="row cell">
        <div class="t-time-wrap">${rowTimeCell(r.arr,r.parr,r.dep,r.pdep)}</div>
        <div class="t-track">${i===0?'<div class="progress"></div>':''}<span class="dot ${i===0?'start':(i===rows.length-1?'end':'mid')}"></span></div>
        <div class="t-name">${r.name||'—'}</div>
        <div class="t-plat">${r.platform||'—'}</div>
      </div>`;
    });
    stopGrid.insertAdjacentHTML('beforeend', html);

    // after render, compute progress
    requestAnimationFrame(()=>setProgress());
  }

  function listOpsFromRemarks(j){
    // Simple heuristic from legs[].remarks[].type or .code
    const items = [];
    try{
      const remarks = [];
      for(const l of (j.legs||[])){
        if(Array.isArray(l.remarks)) remarks.push(...l.remarks);
      }
      const seen = new Set();
      for(const r of remarks){
        const str = (r.summary || r.text || r.code || '').trim();
        if(!str || seen.has(str)) continue;
        seen.add(str);
        // pick icon
        let ico = 'circle-info';
        const s = str.toLowerCase();
        if(/fahrrad|bicy/i.test(s)) ico = 'bicycle';
        else if(/klima|air.?condition/i.test(s)) ico = 'snowflake';
        else if(/rollstuhl|barrier|einstieg/i.test(s)) ico = 'wheelchair';
        else if(/baust|störung|signal/i.test(s)) ico = 'triangle-exclamation';
        items.push({icon:ico, text:str});
        if(items.length>=6) break;
      }
    }catch(e){}
    return items;
  }

  function openTripModal(j, options={}){
    const legs = j?.legs||[];
    const dep = j.departure || legs[0]?.departure;
    const arr = j.arrival || legs[legs.length-1]?.arrival;
    const dur = j.duration || null;
    const changes = Math.max(0, legs.filter(l=>l.line).length - 1);
    const line = legs.find(l=>l.line)?.line;
    const lineName = line?.name || line?.id || legs.find(l=>l.mode)?.mode || '';
    const color = options.color || (lineName ? lineColor(lineName) : getComputedStyle(document.documentElement).getPropertyValue('--accent'));

    // header
    bar.style.background = color;
    metaLeft.innerHTML = `<span class="trip-chip line" style="--line-color:${color}">${iconForProduct(line?.product, line?.mode)} ${lineName||''}</span>`;
    const dest = legs[legs.length-1]?.destination?.name || '—';
    const dtext = `${fmtHM(dep)} → ${fmtHM(arr)} · ${isoDurToHuman(dur, dep, arr)} · ${changes} Umst.`;
    titleEl.textContent = `${dest} — ${dtext}`;

    // ops
    const ops = listOpsFromRemarks(j);
    if(ops.length){
      opsList.innerHTML = ops.map(o=>`<li class="ops-item"><i class="fa-solid fa-${o.icon}"></i><span>${o.text}</span></li>`).join('');
      opsBox.style.display='block';
    }else{
      opsBox.style.display='none';
      opsList.innerHTML='';
    }

    // stops
    buildStops(legs);

    // show
    modal.hidden = false;
    document.body.style.overflow='hidden';
    if(__tripProgressTimer) clearInterval(__tripProgressTimer);
    __tripProgressTimer = setInterval(()=>setProgress(), 20000);
  }

  let __tripProgressTimer=null;
  function close(){
    modal.hidden = true;
    document.body.style.overflow='';
    if(__tripProgressTimer) { clearInterval(__tripProgressTimer); __tripProgressTimer=null; }
  }
  closeBtn.addEventListener('click', close);
  $('[data-close]', modal).addEventListener('click', close);
  modal.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });

  // Expose to app scope
  window.__openTripModal = openTripModal;
})();
</script>


<script id="pin-feature">
(()=>{
  const PIN_STORE_KEY='pinnedJourneysV1';
  const AUTO_UNPIN_AFTER_MS = 30*60*1000; // 30 min after arrival
  let onlyPinned = false;

  const q = (sel, root=document)=>root.querySelector(sel);
  const qa = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

  function loadPinned(){
    try{ return JSON.parse(localStorage.getItem(PIN_STORE_KEY)||'{}')||{} }catch(e){ return {} }
  }
  function savePinned(obj){ localStorage.setItem(PIN_STORE_KEY, JSON.stringify(obj)); }
  function getDirTag(aToB){ return aToB?'A2B':'B2A'; }
  function deriveKey(j){
    try{
      const legs=j?.legs||[];
      const dep=j?.departure||legs?.[0]?.departure||legs?.[0]?.plannedDeparture||'';
      const arr=j?.arrival||legs?.[legs.length-1]?.arrival||legs?.[legs.length-1]?.plannedArrival||'';
      const sig=(legs||[]).map(l=>[(l.line?.name||l.mode||''),(l.origin?.name||''),(l.destination?.name||'')].join('@')).join('|');
      const token=j?.refreshToken||j?.refreshTokenStr||'';
      return token || [dep,arr,sig].join('•');
    }catch(e){ return Math.random().toString(36).slice(2); }
  }
  function getArrivalTs(j){
    try{
      const legs=j?.legs||[];
      const a=j?.arrival||legs?.[legs.length-1]?.arrival||null;
      const p=j?.plannedArrival||legs?.[legs.length-1]?.plannedArrival||null;
      const use=a||p;
      return use ? new Date(use).getTime() : null;
    }catch{ return null; }
  }
  function cleanupPinned(pinned){
    const now=Date.now();
    let changed=false;
    for(const [k,info] of Object.entries(pinned)){
      const ts=getArrivalTs(info?.lastData);
      if(ts && now > ts + AUTO_UNPIN_AFTER_MS){ delete pinned[k]; changed=true; }
    }
    if(changed) savePinned(pinned);
    return pinned;
  }
  async function refreshPinnedEntry(info){
    let j=null;
    if(info?.token && typeof fetchJSON==='function' && typeof API==='string'){
      try{
        const resp=await fetchJSON(`${API}/journeys/refresh?refreshToken=${encodeURIComponent(info.token)}&stopovers=true&language=de`);
        j = resp?.journey || resp?.journeys?.[0] || null;
      }catch(e){ /* ignore */ }
    }
    if(!j) j = info?.lastData||null;
    if(j) info.lastData=j;
    return j;
  }
  async function listRefreshedPinned(aToB){
    let pinned=cleanupPinned(loadPinned());
    const tag=getDirTag(aToB);
    const tuples=Object.entries(pinned).filter(([k,info])=>info?.dir===tag);
    const refreshed = await Promise.all(tuples.map(([k,info])=>refreshPinnedEntry(info)));
    const res=[];
    for(const j of refreshed){ if(j) res.push(j); }
    res.sort((a,b)=>{
      const da=new Date(a?.departure||a?.legs?.[0]?.departure||a?.legs?.[0]?.plannedDeparture||0).getTime();
      const db=new Date(b?.departure||b?.legs?.[0]?.departure||b?.legs?.[0]?.plannedDeparture||0).getTime();
      return da-db;
    });
    // persist potential updates
    const newPinned=loadPinned();
    tuples.forEach(([k,info])=>{ if(info?.lastData) newPinned[k]=info; });
    savePinned(newPinned);
    return res;
  }
  function mergePins(pins, visible){
    const keys=new Set((visible||[]).map(deriveKey));
    const out=[];
    for(const j of pins){
      const k=deriveKey(j);
      if(!keys.has(k)){ out.push(j); keys.add(k); }
    }
    return [...out, ...(visible||[])];
  }
  function isPinnedKey(k){ return !!loadPinned()[k]; }
  function pinJourney(j, aToB){
    const key=deriveKey(j);
    const data=loadPinned();
    data[key]={ dir:getDirTag(aToB), token:j?.refreshToken||j?.refreshTokenStr||null, pinnedAt:Date.now(), lastData:j };
    savePinned(data);
    return key;
  }
  function unpinKey(k){
    const data=loadPinned(); delete data[k]; savePinned(data);
  }

  function ensurePinnedToggle(){
    const wrap = q('.more-wrap');
    if(!wrap || q('#pinnedToggle', wrap)) return;
    const btn=document.createElement('button');
    btn.id='pinnedToggle'; btn.className='btn pressy';
    btn.setAttribute('aria-pressed','false');
    btn.innerHTML='<i class="fa-solid fa-thumbtack"></i> Nur angepinnte';
    btn.addEventListener('click', async ()=>{
      onlyPinned=!onlyPinned;
      btn.setAttribute('aria-pressed', String(onlyPinned));
      try{
        const aToB = (window.activeTab==='route-a');
        if(onlyPinned){
          const pins = await listRefreshedPinned(aToB);
          if(typeof renderJourneysInto_orig==='function'){
            renderJourneysInto_orig('cards', {journeys: pins}, aToB);
            const mi=document.getElementById('moreInfo'); if(mi) mi.textContent='Nur angepinnte Verbindungen';
            const mb=document.getElementById('moreBtn'); if(mb) mb.disabled=true;
          }
        }else{
          const mb=document.getElementById('moreBtn'); if(mb) mb.disabled=false;
          if(typeof loadRoute==='function') loadRoute(aToB);
        }
      }catch(e){ console.warn(e); }
    });
    const moreBtn=q('#moreBtn', wrap);
    wrap.insertBefore(btn, moreBtn||wrap.firstChild);
  }

  function decorateRenderer(){
    if(typeof window.renderJourneysInto!=='function' || window.renderJourneysInto_orig) return;
    window.renderJourneysInto_orig = window.renderJourneysInto;
    window.renderJourneysInto = function(containerId, list, aToB){
      if(!onlyPinned){
        window.renderJourneysInto_orig(containerId, list, aToB);
      }else{
        const wrap=document.getElementById(containerId);
        if(wrap) wrap.innerHTML='<div class="card">Lade angepinnte …</div>';
      }

      (async()=>{
        const pins = await listRefreshedPinned(aToB);
        const finalList = onlyPinned ? pins : mergePins(pins, list?.journeys||[]);
        window.renderJourneysInto_orig(containerId, {journeys: finalList}, aToB);

        const cards=Array.from(document.querySelectorAll('#'+containerId+' .card'));
        const journeys = finalList;
        cards.forEach((card, idx)=>{
          const j = journeys[idx]; if(!j) return;
          const key = deriveKey(j);
          card.dataset.key = key;
          card.dataset.dir = aToB?'A2B':'B2A';
          card.__journey = j;
          if(!card.querySelector('.pin-btn')){
            const btn=document.createElement('button');
            btn.className='pin-btn pressy';
            const pinnedNow=isPinnedKey(key);
            btn.setAttribute('aria-pressed', pinnedNow?'true':'false');
            btn.setAttribute('title', pinnedNow?'Angepinnt – entfernen':'Verbindung anheften');
            btn.setAttribute('aria-label', pinnedNow?'Angepinnt – entfernen':'Verbindung anheften');
            btn.innerHTML='<i class="fa-solid fa-thumbtack" aria-hidden="true"></i>';
            btn.addEventListener('click', (e)=>{
              e.preventDefault(); e.stopPropagation();
              const pressed = btn.getAttribute('aria-pressed')==='true';
              if(pressed){
                unpinKey(key);
                btn.setAttribute('aria-pressed','false');
                card.classList.remove('pinned');
                if(onlyPinned){ card.remove(); }
              }else{
                pinJourney(j, aToB);
                btn.setAttribute('aria-pressed','true');
                card.classList.add('pinned');
              }
            });
            card.prepend(btn);
          }
          if(isPinnedKey(key)) card.classList.add('pinned'); else card.classList.remove('pinned');
        });
      })().catch(console.warn);
    };
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ ensurePinnedToggle(); decorateRenderer(); });
  }else{
    ensurePinnedToggle(); decorateRenderer();
  }
})();
</script>





<!-- === Trip Detail Modal (Premium v3) === -->
<div id="tripModal" class="modal" hidden>
  <div class="modal-backdrop" data-close></div>
  <div class="modal-panel trip-panel" role="dialog" aria-modal="true">
    <div class="trip-head">
      <div class="trip-line">
        <span class="line-pill" id="tripLinePill">—</span>
      </div>
      <div class="trip-center">
        <div class="trip-dest" id="tripDest">Fahrtdetails</div>
        <div class="trip-meta-row" id="tripMetaRow">—</div>
      </div>
      <button class="modal-close pressy" aria-label="Schließen" data-close>
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="modal-body trip-body">
      <div id="tripContent" class="trip-scroll">Lade …</div>
    </div>
  </div>
</div>

<script>
/* ===== Trip Detail (Premium v3) – Chip-colored band, cleaner stoplist, RIS only ===== */
(function(){
  const API = (typeof window.API !== 'undefined') ? window.API : 'https://v6.db.transport.rest';
  const $ = (s,el=document)=>el.querySelector(s);
  const $$= (s,el=document)=>Array.from(el.querySelectorAll(s));
  const fmtHM = (d)=>{ try{ return d? new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) : '—'; }catch(_){ return '—'; } };
  const dmin  = (a,p)=> (a&&p)? Math.round((new Date(a)-new Date(p))/60000) : 0;
  const dcls  = (m)=> m>0? 'late' : (m<0? 'early' : 'ontime');
  const escape = (s)=> (s||'').toString().replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

  const modal = document.getElementById('tripModal');
  const content = document.getElementById('tripContent');
  const destEl  = document.getElementById('tripDest');
  const pillEl  = document.getElementById('tripLinePill');
  const metaRow = document.getElementById('tripMetaRow');
  const panel   = document.querySelector('.trip-panel');

  function openModal(){ modal.hidden = false; }
  function closeModal(){ modal.hidden = true; }
  modal.addEventListener('click', (e)=>{ if(e.target.matches('[data-close], .modal-backdrop')) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !modal.hidden) closeModal(); });

  function risIconByText(t=''){
    const s = t.toLowerCase();
    if(/bauarbeiten|arbeiten|construction|baustelle/.test(s)) return 'fa-person-digging';
    if(/störung|disruption|fault/.test(s)) return 'fa-triangle-exclamation';
    if(/ersatzverkehr|bus/.test(s)) return 'fa-bus';
    if(/wlan|wifi/.test(s)) return 'fa-wifi';
    if(/klima|air-?condition/.test(s)) return 'fa-snowflake';
    if(/fahrrad|bicycle/.test(s)) return 'fa-person-biking';
    if(/rollstuhl|rampe|einstiegshilfe|barriere/.test(s)) return 'fa-wheelchair';
    if(/gleis/.test(s)) return 'fa-train';
    return 'fa-circle-info';
  }

  function buildRIS(remarks){
    if(!remarks || !remarks.length) return '';
    const seen = new Set();
    const items = remarks.filter(r=>{
      const body = r?.text || r?.summary || '';
      const key = body.trim();
      if(!key || seen.has(key)) return false; seen.add(key); return true;
    }).map(r=>{
      const body = escape(r?.text || r?.summary || '');
      const icon = risIconByText(body);
      return `<li class="ris-item"><i class="fa-solid ${icon}" aria-hidden="true"></i><div class="ris-text"><div class="ris-desc">${body}</div></div></li>`;
    }).join('');
    return items ? `<div class="trip-ris"><div class="trip-section-title"><i class="fa-solid fa-bolt"></i> Betriebsinfos</div><ul class="ris-list">${items}</ul></div>` : '';
  }

  function timeCell(s){
    const a = s.arrival, ap = s.plannedArrival;
    const d = s.departure, dp = s.plannedDeparture;
    const parts = [];
    if(a && d && a !== d){
      parts.push(`<div class="tline"><span class="lbl">An</span> <span class="actual ${dcls(dmin(a,ap))}">${fmtHM(a)}</span>${ap?` <span class="planned">(${fmtHM(ap)})</span>`:''}</div>`);
      parts.push(`<div class="tline"><span class="lbl">Ab</span> <span class="actual ${dcls(dmin(d,dp))}">${fmtHM(d)}</span>${dp?` <span class="planned">(${fmtHM(dp)})</span>`:''}</div>`);
    } else if(a){
      parts.push(`<div class="tline"><span class="actual ${dcls(dmin(a,ap))}">${fmtHM(a)}</span>${ap?` <span class="planned">(${fmtHM(ap)})</span>`:''}</div>`);
    } else if(d){
      parts.push(`<div class="tline"><span class="actual ${dcls(dmin(d,dp))}">${fmtHM(d)}</span>${dp?` <span class="planned">(${fmtHM(dp)})</span>`:''}</div>`);
    } else {
      parts.push(`<div class="tline">—</div>`);
    }
    return parts.join('');
  }

  function rowHTML(s, first, last){
    const platform = s.platform || s.prognosedPlatform || s.plannedPlatform || '—';
    const name = escape(s.stop?.name || s.station?.name || '—');
    const railTop = first ? ' rail-top' : '';
    const railBot = last ? ' rail-bot' : '';
    return `<div class="row${railTop}${railBot}">
      <div class="rail"><span class="dot"></span></div>
      <div class="time">${timeCell(s)}</div>
      <div class="stop">${name}</div>
      <div class="plat">${platform?('Gl. '+platform):'—'}</div>
    </div>`;
  }

  async function tryFetchFullTrip(leg){
    const id = leg?.tripId || leg?.id || leg?.trip?.id || null;
    if(!id) return null;
    try{
      const res = await fetch(`${API}/trips/${encodeURIComponent(id)}?stopovers=true&language=de`);
      if(!res.ok) return null;
      return await res.json();
    }catch(_){ return null; }
  }

  function buildMeta(journey, leg){
    const dep = leg?.departure || journey?.departure;
    const arr = leg?.arrival || journey?.arrival;
    const durMin = dep && arr ? Math.max(1, Math.round((new Date(arr)-new Date(dep))/60000)) : null;
    const changes = Math.max(0, (journey?.legs||[]).filter(l=>l.line).length - 1);
    const parts = [];
    if(dep&&arr&&durMin) parts.push(`${fmtHM(dep)} → ${fmtHM(arr)} · ${durMin} min`);
    parts.push(`${changes} Umst.`);
    return parts.join(' · ');
  }

  function renderTrip(journey, leg, fullTrip){
    const lineName = leg?.line?.name || leg?.mode || '';
    const product  = (leg?.line?.product || leg?.mode || '').toUpperCase();
    const dest     = leg?.direction || journey?.to?.name || '';
    destEl.textContent = dest || 'Fahrtdetails';
    pillEl.textContent = [product, lineName].filter(Boolean).join(' ');
    metaRow.textContent = buildMeta(journey, leg);

    const stops = (fullTrip?.stopovers && fullTrip.stopovers.length) ? fullTrip.stopovers : (leg?.stopovers || []);
    const header = `<div class="thead"><div class="rail-h"></div><div>Zeit</div><div>Station</div><div class="plat-h">Gleis</div></div>`;
    const rows = stops.map((s,i)=>rowHTML(s, i===0, i===stops.length-1)).join('');

    // RIS from all sources, German only line (we already drop English headers by using .text or .summary only)
    const remarksRaw = [...(journey?.remarks||[]), ...(leg?.remarks||[]), ...((fullTrip?.remarks)||[])].filter(Boolean);
    const ris = buildRIS(remarksRaw);

    content.innerHTML = `${ris}<div class="trip-stops"><div class="table scroll">${header}<div class="tbody">${rows}</div></div></div>`;
  }

  
  async function openTripForChip(chip){
    if(!chip) return;
    const card = chip.closest('.card'); if(!card || !card.__journey) return;
    const j = card.__journey;
    const chips = Array.from(card.querySelectorAll('.line-chip'));
    const idx = chips.indexOf(chip);
    let k=-1, leg=null;
    for(const L of (j.legs||[])){ if(L && L.line){ k++; if(k===idx){ leg=L; break; } } }
    if(!leg) return;
    try{
      const cs = getComputedStyle(chip);
      const col = cs.getPropertyValue('background-color') || cs.getPropertyValue('color');
      if(col){
        const panel = document.querySelector('.trip-panel');
        panel?.style.setProperty('--accent-band', col.trim());
        panel?.style.setProperty('--accent', col.trim());
        panel?.style.setProperty('--accent-rail', col.trim());
      }
    }catch(_){}
    // Open quickly, then render
    content.innerHTML = '<div class="skeleton"><div class="bar"></div><div class="bar"></div><div class="bar w50"></div></div>';
    destEl.textContent = leg?.direction || 'Fahrtdetails';
    pillEl.textContent = ((leg?.line?.product||leg?.mode||'').toUpperCase() + ' ' + (leg?.line?.name||leg?.mode||'')).trim();
    metaRow.textContent = 'Lade Fahrtdaten …';
    openModal();
    const fullTrip = await tryFetchFullTrip(leg);
    renderTrip(j, leg, fullTrip);
  }
// Delegation
  document.addEventListener('click', async (ev)=>{
    const chip = ev.target.closest?.('.line-chip');
    if(!chip) return;
    const card = chip.closest('.card'); if(!card || !card.__journey) return;
    const j = card.__journey;
    const chips = Array.from(card.querySelectorAll('.line-chip'));
    const idx = chips.indexOf(chip);
    let k=-1, leg=null;
    for(const L of (j.legs||[])){ if(L && L.line){ k++; if(k===idx){ leg=L; break; } } }
    if(!leg) return;

    // Accent band from chip background color
    try{
      const cs = getComputedStyle(chip);
      const col = cs.getPropertyValue('background-color') || cs.getPropertyValue('color');
      if(col) document.querySelector('.trip-panel').style.setProperty('--accent-band', col.trim());
    }catch(_){}

    // Open quickly, then render
    content.innerHTML = '<div class="skeleton"><div class="bar"></div><div class="bar"></div><div class="bar w50"></div></div>';
    destEl.textContent = leg?.direction || 'Fahrtdetails';
    pillEl.textContent = ((leg?.line?.product||leg?.mode||'').toUpperCase() + ' ' + (leg?.line?.name||leg?.mode||'')).trim();
    metaRow.textContent = 'Lade Fahrtdaten …';
    openModal();
    const fullTrip = await tryFetchFullTrip(leg);
    renderTrip(j, leg, fullTrip);
  }, true);

  // focusable chips
  const cardsRoot = document.getElementById('cards');
  if(cardsRoot){
    const mark = ()=>{ cardsRoot.querySelectorAll('.line-chip').forEach(el=>{ el.tabIndex=0; el.setAttribute('role','button'); el.classList.add('clickable'); }); };
    mark();
    new MutationObserver(mark).observe(cardsRoot, {childList:true, subtree:true});
  }
})();
</script>

</body>
</html>
