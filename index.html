<!doctype html>
<html lang="de" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pendler Dashboard</title>

<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="alternate icon" type="image/png" sizes="512x512" href="apple-touch-icon.png">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Pendler Dashboard">

<style>
  /* ================== Design Tokens (iOS-like, Glass) ================== */
  :root{
    --bg:            linear-gradient(135deg,#f6f8ff 0%,#eef2ff 40%,#f9fbff 100%);
    --panel:         rgba(255,255,255,.55);
    --panel-strong:  rgba(255,255,255,.7);
    --text:          #0e1116;
    --muted:         #5e6a7d;
    --rule:          rgba(20,32,50,.08);
    --chip:          rgba(255,255,255,.45);
    --accent:        #0a84ff; /* iOS accent */
    --ok:            #27ae60;
    --warn:          #e67e22;
    --bad:           #e74c3c;
    --ring:          0 0 0 1px rgba(10,132,255,.14), 0 8px 30px rgba(12,22,38,.08);
    --font:          ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    --radius-xl:     18px;
    --radius-lg:     14px;
    --radius-md:     12px;
    --blur:          16px;
    --glass-border:  1px solid rgba(255,255,255,.35);
    --glass-inset:   inset 0 1px 0 rgba(255,255,255,.35), inset 0 -1px 0 rgba(0,0,0,.03);
  }
  [data-theme="dark"]{
    --bg:            radial-gradient(1200px 800px at 10% -10%, #1a2230 0%, #0e141d 40%, #0a0f16 100%);
    --panel:         rgba(20,30,45,.45);
    --panel-strong:  rgba(20,30,45,.6);
    --text:          #ecf2ff;
    --muted:         #a2b0c6;
    --rule:          rgba(255,255,255,.06);
    --chip:          rgba(255,255,255,.07);
    --accent:        #2997ff;
    --ring:          0 0 0 1px rgba(41,151,255,.20), 0 10px 40px rgba(3,10,20,.6);
    --glass-border:  1px solid rgba(255,255,255,.18);
    --glass-inset:   inset 0 1px 0 rgba(255,255,255,.12), inset 0 -1px 0 rgba(0,0,0,.25);
  }

  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:var(--font);
    background:var(--bg) fixed; -webkit-font-smoothing:antialiased;
  }

  /* ================== Header & Tabs (Glass) ================== */
  .hdr{
    position:sticky; top:0; z-index:60;
    display:flex; align-items:center; gap:16px; padding:14px 18px;
    backdrop-filter:saturate(140%) blur(14px);
    background:var(--panel-strong);
    border-bottom: var(--glass-border);
    box-shadow: var(--ring);
  }
  .brand{ font-weight:900; letter-spacing:.2px; font-size:22px; }
  .spacer{flex:1}
  .iconbtn{
    border:var(--glass-border); background:var(--chip); color:var(--text);
    border-radius: 100px; padding:10px 12px;
    display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none;
    box-shadow: var(--glass-inset), var(--ring);
  }
  .iconbtn i{ font-size:18px }

  .tabs{
    position:sticky; top:56px; z-index:55;
    display:flex; gap:10px; padding:10px 16px;
    overflow:auto hidden; backdrop-filter: blur(10px);
    background:var(--panel);
    border-bottom: var(--glass-border);
  }
  .tab{
    padding:10px 14px; border-radius: 999px; white-space:nowrap; text-decoration:none;
    color:var(--muted); border:var(--glass-border); background:transparent;
    flex:0 0 auto; font-weight:800; font-size:15px;
  }
  .tab.active{ color:var(--text); background:var(--panel-strong); box-shadow: var(--glass-inset); }

  /* ================== Canvas / Panels ================== */
  .wrap{ padding:16px; max-width:1600px; margin:0 auto; }
  .panel{
    background: transparent; /* wir lassen die Cards „schweben“ */
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  /* ================== Journey Cards (Glass Tiles) ================== */
  .cards{
    display:grid; grid-template-columns:1fr; gap:16px;
  }
  @media (min-width: 1000px){ .cards{ grid-template-columns:1fr 1fr; } }
  @media (min-width: 1440px){ .cards{ grid-template-columns:1fr 1fr 1fr; } }

  .card{
    position:relative; overflow:hidden;
    padding:16px 16px 12px;
    border-radius: var(--radius-xl);
    background: var(--panel);
    border: var(--glass-border);
    box-shadow: var(--ring);
    backdrop-filter: saturate(140%) blur(var(--blur));
  }
  .card::after{ /* sanfter Glanz */
    content:''; position:absolute; inset:0;
    background: linear-gradient(180deg, rgba(255,255,255,.18), transparent 40%);
    pointer-events:none;
  }
  .card:hover{ transform: translateY(-1px); transition: transform .25s ease; }

  .row1{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .dep,.arr{ font-variant-numeric:tabular-nums; font-weight:900; font-size:20px; }
  .meta{ color:var(--muted); }
  .badge{
    display:inline-flex; align-items:center; gap:8px;
    background: var(--chip);
    border: var(--glass-border);
    border-radius: 12px; padding:6px 10px; font-weight:800;
    box-shadow: var(--glass-inset);
  }
  .badge i{ opacity:.95 }

  .chips{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    background: var(--chip);
    border: var(--glass-border);
    border-radius: 999px; padding:6px 10px; font-weight:800;
    box-shadow: var(--glass-inset); font-size:13px;
  }
  .chip.sm{ padding:4px 8px; font-size:12px; }

  /* Compact timeline – noch cleaner */
  .timeline{
    display:grid; grid-template-columns:22px 1fr auto; gap:8px 14px;
    margin-top:12px; padding:12px;
    border-radius: 14px;
    background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.12));
    border: var(--glass-border);
    box-shadow: var(--glass-inset);
    backdrop-filter: blur(10px);
  }
  .tl-icon{ text-align:center; color:var(--muted); }
  .tl-stop{ font-weight:800; }
  .tl-time,.tl-range{ color:var(--muted); font-variant-numeric:tabular-nums; white-space:nowrap; }
  .tl-wait{ margin-left:8px; color:var(--muted); font-size:12px; }
  .late{ color:var(--bad) !important; font-weight:900; }
  .early{ color:var(--ok) !important; font-weight:900; }

  /* ================== Tables (Departures) ================== */
  table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
  thead th{
    position:sticky; top: calc(56px + 48px); z-index:5;
    text-align:left; padding:10px 12px; color:var(--muted);
    backdrop-filter: blur(10px); background: var(--panel-strong);
    border: var(--glass-border); border-radius:12px;
  }
  thead th .hcell{ display:flex; align-items:center; gap:8px; }
  tbody tr{
    background: var(--panel); border: var(--glass-border);
    box-shadow: var(--ring); backdrop-filter: blur(8px);
  }
  tbody td{
    padding:12px 14px; vertical-align:middle;
  }
  tbody tr td:first-child{ border-top-left-radius:12px; border-bottom-left-radius:12px; }
  tbody tr td:last-child{ border-top-right-radius:12px; border-bottom-right-radius:12px; }
  .line{ font-weight:600; }
  .delta{ font-variant-numeric:tabular-nums; font-weight:900; }
  .delta.late{ color:var(--bad); }
  .delta.early{ color:var(--ok); }
  .delta.ontime{ color:var(--muted); }
  .err{ color:#ff4d4f; padding:12px 0; }

  /* ================== Footer ================== */
  footer{
    margin:16px; padding:10px 14px; color:var(--muted); font-size:13px; display:flex; gap:12px; align-items:center;
    backdrop-filter: blur(10px); background: var(--panel); border: var(--glass-border); border-radius: 12px; box-shadow: var(--ring);
  }
  footer .dot{ opacity:.5 }

  /* iPhone tweaks */
  @media (max-width: 740px){
    .hdr{ padding:12px 14px; }
    .brand{ font-size:18px; }
    .tab{ font-size:14px; padding:8px 10px; }
    .badge{ padding:4px 8px; }
    thead th, tbody td{ padding:10px 12px; }
    .col-steig, .col-plan{ display:none; }
    .timeline{ grid-template-columns:20px 1fr auto; }
  }

  /* CTA Button */
  .more-wrap{ padding:12px; display:flex; justify-content:center; }
  .more-btn{
    border:var(--glass-border); background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.25));
    color:var(--text); border-radius: 999px; padding:10px 16px; font-weight:900; cursor:pointer;
    box-shadow: var(--glass-inset), var(--ring);
  }
  .more-btn:disabled{ opacity:.6; cursor:not-allowed; }
</style>
</head>
<body>
  <div class="hdr" role="banner">
    <div class="brand">Pendler Dashboard</div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" aria-label="Theme umschalten (Hell/Dunkel)">
      <i class="fa-solid fa-sun" id="sunIcon"></i>
      <i class="fa-solid fa-moon" id="moonIcon" style="display:none"></i>
    </button>
  </div>

  <nav class="tabs" role="tablist" aria-label="Ansichten">
    <a href="#route-a"   class="tab active" role="tab" aria-selected="true"  id="tab-a">Gießen → Frankfurt(Main) Hbf</a>
    <a href="#route-b"   class="tab"        role="tab" aria-selected="false" id="tab-b">Frankfurt(Main) Hbf → Gießen</a>
    <a href="#abfahrten" class="tab"        role="tab" aria-selected="false" id="tab-c">Abfahrten (stadt­einwärts)</a>
    <a href="#homebound" class="tab"        role="tab" aria-selected="false" id="tab-d">Abfahrten (heimwärts)</a>
  </nav>

  <div class="wrap">
    <div class="panel" id="panel">
      <!-- Routen -->
      <div id="view-route" hidden>
        <div id="cards" class="cards"><div class="card">Lade Verbindungen …</div></div>
        <div class="more-wrap"><button id="moreBtn" class="more-btn">Weitere Verbindungen</button></div>
      </div>

      <!-- Abfahrten stadt­einwärts -->
      <div id="view-abfahrten" hidden>
        <table>
          <thead>
            <tr>
              <th style="width:140px;"><div class="hcell"><i class="fa-solid fa-arrow-right-long"></i> Abfahrt</div></th>
              <th class="col-plan" style="width:140px;"><div class="hcell"><i class="fa-regular fa-clock"></i> Plan</div></th>
              <th style="width:220px;"><div class="hcell"><i class="fa-solid fa-train"></i> Linie</div></th>
              <th><div class="hcell"><i class="fa-solid fa-location-dot"></i> Ziel</div></th>
              <th class="col-steig" style="width:120px;"><div class="hcell"><i class="fa-solid fa-signs-post"></i> Steig</div></th>
              <th style="width:100px;"><div class="hcell"><i class="fa-solid fa-clock-rotate-left"></i> +-</div></th>
            </tr>
          </thead>
          <tbody id="rows"><tr><td colspan="6" style="padding:18px;color:var(--muted)">Lade Abfahrten …</td></tr></tbody>
        </table>
        <div class="err" id="depErr" hidden></div>
      </div>

      <!-- Abfahrten heimwärts -->
      <div id="view-homebound" hidden>
        <table>
          <thead>
            <tr>
              <th style="width:140px;"><div class="hcell"><i class="fa-solid fa-arrow-right-long"></i> Abfahrt</div></th>
              <th class="col-plan" style="width:140px;"><div class="hcell"><i class="fa-regular fa-clock"></i> Plan</div></th>
              <th style="width:200px;"><div class="hcell"><i class="fa-solid fa-location-dot"></i> Abfahrts­halt</div></th>
              <th style="width:200px;"><div class="hcell"><i class="fa-solid fa-train"></i> Linie</div></th>
              <th><div class="hcell"><i class="fa-solid fa-flag-checkered"></i> Ziel</div></th>
              <th class="col-steig" style="width:120px;"><div class="hcell"><i class="fa-solid fa-signs-post"></i> Steig</div></th>
              <th style="width:100px;"><div class="hcell"><i class="fa-solid fa-clock-rotate-left"></i> +-</div></th>
            </tr>
          </thead>
          <tbody id="rows-home"><tr><td colspan="7" style="padding:18px;color:var(--muted)">Lade Abfahrten …</td></tr></tbody>
        </table>
        <div class="err" id="homeErr" hidden></div>
      </div>
    </div>
  </div>

  <footer>
    <span id="refreshInfo">Aktualisierung: —</span><span class="dot">•</span><span id="lastUpdated">Zuletzt: —</span>
  </footer>

<script>
/* ========= Config ========= */
const API = 'https://v6.db.transport.rest';
const Q_SCHOOL   = 'Sophie-Scholl-Schule Gießen';
const Q_FFMHBF   = 'Frankfurt(Main) Hbf';
const Q_FRIEDR   = 'Friedrichstraße Gießen';
const Q_GIESSEN  = 'Gießen Bahnhof';

const REFRESH_ROUTE_MS = 60000;
const REFRESH_DEPS_MS  = 30000;

const EXCLUDE_DIRECTIONS = [/rödgen/i, /coleman\s*str/i];

let ids = { school:null, ffm:null, friedr:null, giessenBhf:null };
let activeTab = 'route-a';
let timer = null;
let lastUpdated = null;

/* Lang/Kurz – bleibt lang bei Auto-Refresh; Reset bei Tabwechsel/Reload */
let moreShownOnce = false;

/* ========= Theme ========= */
const mediaDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
const sunIcon = document.getElementById('sunIcon');
const moonIcon= document.getElementById('moonIcon');
const themeBtn= document.getElementById('themeBtn');
function systemTheme(){ return mediaDark && mediaDark.matches ? 'dark' : 'light'; }
function applyTheme(mode){
  document.documentElement.setAttribute('data-theme', mode);
  if(mode==='dark'){ sunIcon.style.display='none'; moonIcon.style.display='inline-block'; }
  else { moonIcon.style.display='none'; sunIcon.style.display='inline-block'; }
}
(function initTheme(){
  applyTheme(systemTheme());
  if(mediaDark?.addEventListener) mediaDark.addEventListener('change', e => applyTheme(e.matches ? 'dark':'light'));
})();
themeBtn.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || systemTheme();
  applyTheme(cur==='light'?'dark':'light');
});

/* ========= Helpers ========= */
const fmtHM  = d => new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
const fmtHMS = d => new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
function isoDurToHuman(iso, dep, arr){
  if(iso){ const h=(iso.match(/(\d+)H/)||[])[1]|0, m=(iso.match(/(\d+)M/)||[])[1]|0; return (h?`${h} h `:'')+String(m).padStart(2,'0')+' min'; }
  if(dep&&arr){ const diff=Math.max(0,Math.round((new Date(arr)-new Date(dep))/60000)); const h=Math.floor(diff/60), m=diff%60; return (h?`${h} h `:'')+String(m).padStart(2,'0')+' min'; }
  return '–';
}
function setFooter(ms){
  document.getElementById('refreshInfo').textContent = 'Aktualisierung: alle ' + Math.round(ms/1000) + ' s';
  document.getElementById('lastUpdated').textContent = 'Zuletzt: ' + (lastUpdated ? fmtHMS(lastUpdated) : '—');
}
async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(`${url} → ${r.status}`);
  lastUpdated = Date.now();
  setFooter((activeTab==='abfahrten'||activeTab==='homebound') ? REFRESH_DEPS_MS : REFRESH_ROUTE_MS);
  return r.json();
}
async function findStopId(query, preferRx){
  const url = `${API}/locations?query=${encodeURIComponent(query)}&results=10&stops=true`;
  const data = await fetchJSON(url);
  if(preferRx){
    const hit = data.find(x => (x.type==='stop'||x.type==='station') && preferRx.test((x.name||'') + ' ' + (x.address?.city||'')));
    if(hit) return hit.id;
  }
  const first = data.find(x => x.type==='stop' || x.type==='station');
  return first?.id || null;
}

/* ========= Linienfarben ========= */
const FIXED_COLORS = {
  'Bus 1':'#3498db','1':'#3498db',
  'Bus 17':'#e67e22','17':'#e67e22',
  'RB40':'#9b59b6','RB41':'#1abc9c',
  'RE30':'#f1c40f','S6':'#2ecc71',
  'ICE':'#2c3e50','IC':'#34495e'
};
const HUES = [168,145,204,282,48,28,6,210,320,260,100,36,14,190,230,75];
function hashLine(s){ let h=0; for(const ch of String(s)) h=((h<<5)-h)+ch.charCodeAt(0), h|=0; return Math.abs(h); }
function lineColor(name){
  if(!name) return '#7f8c8d';
  const key = String(name).trim();
  if (FIXED_COLORS[key]) return FIXED_COLORS[key];
  const norm = key.replace(/\s+Richtung.*/i,'').trim();
  if (FIXED_COLORS[norm]) return FIXED_COLORS[norm];
  const hue = HUES[ hashLine(key) % HUES.length ];
  const isDark = (document.documentElement.getAttribute('data-theme') === 'dark');
  const sat = 80; const light = isDark ? 70 : 35;
  return `hsl(${hue} ${sat}% ${light}%)`;
}
function iconForProduct(product, mode){
  const p = (product||'').toLowerCase(), m = (mode||'').toLowerCase();
  if(p.includes('bus') || m==='bus') return '<i class="fa-solid fa-bus"></i>';
  if(p.includes('suburban') || p.includes('s-bahn') || m==='subway') return '<i class="fa-solid fa-train-subway"></i>';
  if(p.includes('tram')) return '<i class="fa-solid fa-train-tram"></i>';
  return '<i class="fa-solid fa-train"></i>';
}
function prettyStopName(name){ return name==='Gießen' ? 'Gießen Bahnhof' : name; }

/* ========= Timeline ========= */
function buildCompactTimeline(legs){
  if(!legs?.length) return '';
  const nodes = [];
  nodes.push({type:'start', name:prettyStopName(legs[0]?.origin?.name||'—'), dep:legs[0]?.departure||null, pdep:legs[0]?.plannedDeparture||null, product:legs[0]?.line?.product||legs[0]?.mode||''});
  for(let i=0;i<legs.length;i++){
    const l=legs[i], next=legs[i+1];
    const destName=prettyStopName(l.destination?.name||'—');
    const node = { type:'mid', name:destName, arr:l.arrival||null, parr:l.plannedArrival||null, dep:null, pdep:null, product:(next?.line?.product||next?.mode||l?.line?.product||l?.mode||'') };
    if(next && next.origin?.name === l.destination?.name){ node.dep = next.departure || null; node.pdep = next.plannedDeparture || null; }
    nodes.push(node);
  }
  nodes[nodes.length-1].type='end';

  function cls(actual, planned){
    if(!actual || !planned) return '';
    const m = Math.round((new Date(actual) - new Date(planned))/60000);
    if(m>0) return 'late'; if(m<0) return 'early'; return '';
  }
  function chooseIcon(n){
    if(n.type==='start') return iconForProduct(n.product,'');
    if(n.type==='end')  return '<i class="fa-solid fa-flag-checkered"></i>';
    if(!n.dep || !n.arr) return '<i class="fa-solid fa-location-dot"></i>';
    if(/walk/i.test(n.product)) return '<i class="fa-solid fa-person-walking"></i>';
    if(/bus/i.test(n.product))  return '<i class="fa-solid fa-bus"></i>';
    return '<i class="fa-solid fa-train"></i>';
  }

  const fmt = v=>v?fmtHM(v):'—';
  return nodes.map(n=>{
    let right='';
    if(n.type==='start'){
      const c = cls(n.dep, n.pdep); right = `<span class="tl-time ${c}">${fmt(n.dep)}</span>`;
    } else if(n.type==='end'){
      const c = cls(n.arr, n.parr); right = `<span class="tl-time ${c}">${fmt(n.arr)}</span>`;
    } else {
      const wait = (n.arr && n.dep) ? Math.max(0,Math.round((new Date(n.dep)-new Date(n.arr))/60000)) : null;
      const c1 = cls(n.arr, n.parr), c2 = cls(n.dep, n.pdep);
      const range = `<span class="${c1}">${fmt(n.arr)}</span> ▸ <span class="${c2}">${fmt(n.dep)}</span>`;
      right = `<span class="tl-range">${range}</span>${(wait&&wait>0)?`<span class="tl-wait">• ${wait}′ Umstieg</span>`:''}`;
    }
    return `<div class="tl-icon">${chooseIcon(n)}</div><div class="tl-stop">${n.name}</div><div style="text-align:right">${right}</div>`;
  }).join('');
}

/* ========= Journeys renderer (Cards) ========= */
function renderJourneysInto(containerId, list, aToB){
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = '';
  const journeys = list?.journeys || [];
  if(!journeys.length){ wrap.innerHTML = `<div class="card">Keine Verbindungen gefunden.</div>`; return; }

  for(const j of journeys){
    const legs = j.legs || [];
    const dep = j.departure || legs[0]?.departure;
    const arr = j.arrival || legs[legs.length-1]?.arrival;
    const changes = Math.max(0, legs.filter(l=>l.line).length - 1);
    const durHuman = isoDurToHuman(j.duration, dep, arr);

    let delayMin = 0; const l0 = legs.find(l => !!l.departure);
    if(l0 && l0.plannedDeparture && l0.departure) delayMin = Math.round((new Date(l0.departure) - new Date(l0.plannedDeparture))/60000);
    const delayChip = (delayMin!==0)
      ? `<span class="badge" style="color:${delayMin>0?'var(--bad)':'var(--ok)'}"><i class="fa-solid fa-clock-rotate-left"></i> ${delayMin>0? '+'+delayMin: delayMin}′</span>` : '';

    const chips = legs.filter(l => l.line).map(l => {
      const line = l.line?.name || l.mode || '';
      return `<span class="chip" style="color:${lineColor(line)}">${iconForProduct(l.line?.product, l.mode)} ${line}</span>`;
    }).join('');

    const subtitle = aToB ? 'Sophie-Scholl-Schule → Frankfurt(Main) Hbf'
                          : 'Frankfurt(Main) Hbf → Sophie-Scholl-Schule';

    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div class="row1">
        <div class="dep">${fmtHM(dep)}</div>
        <div class="meta">→</div>
        <div class="arr">${fmtHM(arr)}</div>
        <span class="badge" title="Dauer"><i class="fa-regular fa-clock"></i> ${durHuman}</span>
        <span class="badge" title="Umstiege"><i class="fa-solid fa-right-left"></i> ${changes}</span>
        ${delayChip || ''}
      </div>
      <div class="chips">${chips || '<span class="chip"><i class="fa-solid fa-person-walking"></i> Fußweg</span>'}</div>
      <div class="timeline" role="list">${buildCompactTimeline(legs)}</div>
      <div class="meta" style="margin-top:8px">${subtitle}</div>
    `;
    wrap.appendChild(el);
  }
}

/* ========= Departures (Tables) ========= */
function normalizeDepartures(raw){ if(Array.isArray(raw)) return raw; if(raw && Array.isArray(raw.departures)) return raw.departures; return []; }
function deltaClass(m){ if(m>0) return 'late'; if(m<0) return 'early'; return 'ontime'; }
function renderDeparturesInto(tbodyId, departures){
  const tbody = document.getElementById(tbodyId);
  tbody.innerHTML = '';
  if(!departures.length){
    tbody.innerHTML = `<tr><td colspan="6" style="padding:18px;color:var(--muted)">Keine passenden Abfahrten.</td></tr>`;
    return;
  }
  for(const d of departures){
    const line = d.line?.name || d.line?.id || '–';
    const dir0 = d.direction || d.destination || '–';
    const dir  = prettyStopName(dir0);
    const pl   = d.platform || d.prognosedPlatform || d.plannedPlatform || '–';
    const tPl  = d.plannedWhen || d.when || d.scheduledWhen;
    const tRt  = d.prognosedWhen || d.when || null;

    let deltaTxt = '–', cls='ontime';
    if(tPl && tRt){ const m = Math.round((new Date(tRt) - new Date(tPl))/60000); deltaTxt = (m>0? '+'+m : m) + '′'; cls = deltaClass(m); }

    const color = lineColor(line);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${tRt ? fmtHM(tRt) : (tPl?fmtHM(tPl):'–')}</td>
      <td class="col-plan">${tPl ? fmtHM(tPl) : '–'}</td>
      <td class="line"><span class="chip sm" style="color:${color}">${iconForProduct(d.line?.product, d.line?.mode)} ${line}</span></td>
      <td>${dir}</td>
      <td class="col-steig">${pl}</td>
      <td class="delta ${cls}">${deltaTxt}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* Heimwärts Renderer mit Abfahrts-Halt */
function renderHomeDeparturesInto(tbodyId, departures){
  const tbody = document.getElementById(tbodyId);
  tbody.innerHTML = '';
  if(!departures.length){
    tbody.innerHTML = `<tr><td colspan="7" style="padding:18px;color:var(--muted)">Keine passenden Abfahrten.</td></tr>`;
    return;
  }
  for(const d of departures){
    const line = d.line?.name || d.line?.id || '–';
    const origin = d.originLabel || '–';
    const dir  = 'Sophie-Scholl-Schule, Gießen';
    const pl   = d.platform || d.prognosedPlatform || d.plannedPlatform || '–';
    const tPl  = d.plannedWhen || d.when || d.scheduledWhen;
    const tRt  = d.prognosedWhen || d.when || null;

    let deltaTxt = '–', cls='ontime';
    if(tPl && tRt){ const m = Math.round((new Date(tRt) - new Date(tPl))/60000); deltaTxt = (m>0? '+'+m : m) + '′'; cls = deltaClass(m); }

    const color = lineColor(line);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${tRt ? fmtHM(tRt) : (tPl?fmtHM(tPl):'–')}</td>
      <td class="col-plan">${tPl ? fmtHM(tPl) : '–'}</td>
      <td>${origin}</td>
      <td class="line"><span class="chip sm" style="color:${color}">${iconForProduct(d.line?.product, d.line?.mode)} ${line}</span></td>
      <td>${dir}</td>
      <td class="col-steig">${pl}</td>
      <td class="delta ${cls}">${deltaTxt}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ========= Loaders ========= */
async function ensureIds(){
  if(!ids.school)      ids.school      = await findStopId(Q_SCHOOL, /(sophie|scholl).*(gie(s|ß)en)/i);
  if(!ids.ffm)         ids.ffm         = await findStopId(Q_FFMHBF, /(frankfurt).*(hbf)/i);
  if(!ids.friedr)      ids.friedr      = await findStopId(Q_FRIEDR, /(friedrichs?tra(ß|ss)e).*(gie(s|ß)en)/i);
  if(!ids.giessenBhf)  ids.giessenBhf  = await findStopId(Q_GIESSEN, /(gie(s|ß)en).*(bahnhof|hbf)/i);
}

/* Routen (Kurz/Lang – lang bleibt bei Auto-Refresh) */
async function loadRoute(aToB=true, extra=false){
  try{
    await ensureIds();
    const from = aToB ? ids.school : ids.ffm;
    const to   = aToB ? ids.ffm    : ids.school;
    const results = extra ? 24 : 8;
    const url = `${API}/journeys?from=${from}&to=${to}&results=${results}&stopovers=true&language=de`;
    const data = await fetchJSON(url);
    if(extra){ renderJourneysInto('cards', data, aToB); }
    else { renderJourneysInto('cards', {journeys:(data.journeys||[]).slice(0,8)}, aToB); }
  }catch(e){ document.getElementById('cards').innerHTML = `<div class="card">Fehler: ${e.message}</div>`; }
}

/* Stadteinwärts */
async function loadInbound(){
  try{
    await ensureIds();
    const url = `${API}/stops/${ids.school}/departures?duration=120&language=de`;
    const deps = normalizeDepartures(await fetchJSON(url));
    const filtered = deps.filter(d => !EXCLUDE_DIRECTIONS.some(rx => rx.test(String(d.direction||d.destination||''))));
    renderDeparturesInto('rows', filtered);
    document.getElementById('depErr').hidden = true;
  }catch(e){ const el=document.getElementById('depErr'); el.hidden=false; el.textContent=e.message; }
}

/* Heimwärts: nur Bus 17 (Bhf → Schule) & Bus 1 (Friedrichstraße → Schule) */
async function loadHomebound(){
  try{
    await ensureIds();
    const [j17, j1] = await Promise.all([
      fetchJSON(`${API}/journeys?from=${ids.giessenBhf}&to=${ids.school}&results=20&language=de`),
      fetchJSON(`${API}/journeys?from=${ids.friedr}&to=${ids.school}&results=20&language=de`)
    ]);

    const rows = [];
    function pushRows(data, requiredLineRegex, originLabel){
      const journeys = data?.journeys || [];
      for(const j of journeys){
        const legs = j.legs || [];
        const firstLineLeg = legs.find(l => l.line && (l.departure || l.plannedDeparture));
        if(!firstLineLeg) continue;
        const lineName = firstLineLeg.line?.name || '';
        if(!requiredLineRegex.test(lineName)) continue;
        rows.push({
          originLabel,
          line:{name:lineName, product:firstLineLeg.line?.product},
          when:firstLineLeg.departure || firstLineLeg.plannedDeparture,
          plannedWhen:firstLineLeg.plannedDeparture || firstLineLeg.departure,
          prognosedWhen:firstLineLeg.departure || null,
          platform:firstLineLeg.platform || firstLineLeg.plannedPlatform || firstLineLeg.prognosedPlatform || '–'
        });
      }
    }
    pushRows(j17, /\b(17|Bus\s*17)\b/i, 'Gießen Bahnhof');
    pushRows(j1,  /\b(1|Bus\s*1)\b/i,  'Friedrichstraße, Gießen');

    rows.sort((a,b)=> new Date(a.when||a.plannedWhen) - new Date(b.when||b.plannedWhen));
    const out=[], seen=new Set();
    for(const r of rows){
      const k=(r.originLabel||'')+'|'+(r.line?.name||'')+'|'+(r.when||r.plannedWhen);
      if(!seen.has(k)){ seen.add(k); out.push(r); }
    }
    renderHomeDeparturesInto('rows-home', out.slice(0,20));
    document.getElementById('homeErr').hidden = true;
  }catch(e){ const el=document.getElementById('homeErr'); el.hidden=false; el.textContent=e.message; }
}

/* ========= Tabs & Intervals ========= */
function setTabs(tab){
  activeTab = tab;
  moreShownOnce = false; // Tabwechsel -> wieder Kurzliste

  for(const a of document.querySelectorAll('.tab')){
    const act = a.getAttribute('href') === '#'+tab;
    a.classList.toggle('active', act);
    a.setAttribute('aria-selected', String(act));
  }
  document.getElementById('view-route').hidden      = !(tab==='route-a' || tab==='route-b');
  document.getElementById('view-abfahrten').hidden  = (tab!=='abfahrten');
  document.getElementById('view-homebound').hidden  = (tab!=='homebound');
}
function startRefresh(){
  if(timer) clearInterval(timer);
  if(activeTab==='abfahrten'){ setFooter(REFRESH_DEPS_MS); loadInbound();  timer=setInterval(loadInbound,  REFRESH_DEPS_MS); }
  else if(activeTab==='homebound'){ setFooter(REFRESH_DEPS_MS); loadHomebound(); timer=setInterval(loadHomebound, REFRESH_DEPS_MS); }
  else {
    const aToB = activeTab==='route-a';
    setFooter(REFRESH_ROUTE_MS);
    loadRoute(aToB, /*extra*/ moreShownOnce);
    timer=setInterval(()=>loadRoute(aToB, /*extra*/ moreShownOnce), REFRESH_ROUTE_MS);
  }
}
function handleHash(){
  const hash = (location.hash || '#route-a').replace('#','');
  const allowed = ['route-a','route-b','abfahrten','homebound'];
  setTabs(allowed.includes(hash) ? hash : 'route-a'); startRefresh();
}
window.addEventListener('hashchange', handleHash);
for(const a of document.querySelectorAll('.tab')){
  a.addEventListener('click', (e)=>{ e.preventDefault(); history.replaceState(null,'',a.getAttribute('href')); handleHash(); });
}

/* „Weitere Verbindungen“ */
const moreBtn = document.getElementById('moreBtn');
moreBtn.addEventListener('click', async ()=>{
  if(!(activeTab==='route-a' || activeTab==='route-b')) return;
  const aToB = activeTab==='route-a';
  const prev = moreBtn.innerHTML;
  moreBtn.disabled = true;
  moreBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Lädt…';
  try{
    moreShownOnce = true;
    await loadRoute(aToB, true);
  }finally{
    moreBtn.disabled = false;
    moreBtn.innerHTML = prev;
  }
});

(function init(){ handleHash(); })();
</script>
</body>
</html>
