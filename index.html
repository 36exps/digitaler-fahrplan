<!doctype html>
<html lang="de" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
<title>Digitaler Fahrplan</title>

<!-- iOS/PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Digitaler Fahrplan">

<!-- Icons -->
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="alternate icon" type="image/png" sizes="512x512" href="apple-touch-icon.png">

<!-- Font Awesome Free -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

<style>
  /* ===== Base & Tokens ===== */
  :root{
    --bg: #e7eef6;
    --text: #0f1722;
    --muted: #526077;

    --accent: #0a84ff;
    --rule: rgba(15,23,34,.10);

    /* Glass tuned for iOS readability */
    --glass-bg: rgba(255,255,255,.78);
    --glass-border: rgba(0,0,0,.08);
    --glass-inner: rgba(255,255,255,.85);
    --shadow: 0 1px 2px rgba(16,19,23,.05), 0 16px 40px rgba(16,19,23,.12);
    --radius: 16px;

    --chip-bg: rgba(255,255,255,.92);
    --chip-border: rgba(0,0,0,.08);

    --ok:#1fa463; --bad:#e03131;
  }
  [data-theme="dark"]{
    --bg: #0b1119;
    --text: #eaf1ff;
    --muted:#a6b8cf;

    --rule: rgba(255,255,255,.08);

    --glass-bg: rgba(16,22,34,.58);
    --glass-border: rgba(255,255,255,.10);
    --glass-inner: rgba(255,255,255,.10);
    --shadow: 0 0 0 rgba(0,0,0,0);

    --chip-bg: rgba(255,255,255,.10);
    --chip-border: rgba(255,255,255,.10);
  }

  html,body{height:100%}
  html{ -webkit-text-size-adjust:100%; text-size-adjust:100% }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font: 600 16px/1.45 ui-system, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    -webkit-font-smoothing:antialiased;
    padding-top:env(safe-area-inset-top);
    padding-left:env(safe-area-inset-left);
    padding-right:env(safe-area-inset-right);
    overflow-x:hidden;
  }

  /* ===== Glass + Shelf ===== */
  .glass{
    background: var(--glass-bg);
    backdrop-filter: blur(18px) saturate(180%);
    -webkit-backdrop-filter: blur(18px) saturate(180%);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow);
  }
  .shelf{ position:relative }
  .shelf::before{
    content:""; pointer-events:none;
    position:absolute; left:0; right:0; top:0; height:22px;
    background: linear-gradient(to bottom,
      rgba(255,255,255,.75),
      rgba(255,255,255,.40) 45%,
      rgba(255,255,255,0) 100%);
    border-top-left-radius: inherit; border-top-right-radius: inherit;
    mix-blend-mode: screen; opacity:.95;
  }
  [data-theme="dark"] .shelf::before{
    background: linear-gradient(to bottom,
      rgba(255,255,255,.30),
      rgba(255,255,255,.14) 50%,
      rgba(255,255,255,0) 100%);
    opacity:.8;
  }

  /* ===== Topbar ===== */
  .tabs{
    position:sticky; top:0; z-index:100; /* höher als Drawer-Backdrop */
    display:flex; align-items:center; gap:10px;
    padding:10px 14px;
    border-bottom:1px solid var(--glass-border);
    background: var(--glass-bg);
    backdrop-filter: blur(18px) saturate(180%);
    -webkit-backdrop-filter: blur(18px) saturate(180%);
  }
  .tabs .left{display:flex; gap:8px; flex-wrap:wrap}
  .app-title{display:none; font-weight:800; letter-spacing:.2px}
  .tab{
    appearance:none; border:1px solid var(--glass-border);
    background: var(--chip-bg);
    color:var(--muted);
    border-radius:12px; padding:10px 14px;
    text-decoration:none; font-weight:800; font-size:15px; white-space:nowrap;
  }
  .tab.active{
    color:var(--accent);
    outline: 1px solid color-mix(in oklab, var(--accent) 28%, transparent);
    background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.80));
  }
  [data-theme="dark"] .tab.active{
    background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  }

  .spacer{flex:1}

  .theme-btn,.hamburger{
    border:1px solid var(--glass-border);
    border-radius:12px; padding:9px 12px; display:flex; align-items:center; gap:8px; cursor:pointer;
    background:var(--chip-bg);
  }
  .theme-btn i, .hamburger i{font-size:18px}
  .hamburger{ display:none }

  /* Drawer */
  .drawer{ position:fixed; inset:0; pointer-events:none; z-index:200; }
  .drawer.open{ pointer-events:auto; }
  .drawer-backdrop{
    position:absolute; inset:0; background:rgba(0,0,0,.35); opacity:0; transition:opacity .2s ease;
  }
  .drawer.open .drawer-backdrop{ opacity:1; }
  .drawer-panel{
    position:absolute; top:0; left:0; height:100%; width:300px; max-width:85vw;
    border-right:1px solid var(--glass-border);
    display:flex; flex-direction:column; padding:14px;
    background: var(--glass-bg);
    backdrop-filter: blur(18px) saturate(180%);
    -webkit-backdrop-filter: blur(18px) saturate(180%);
  }
  .drawer-title{ font-weight:800; margin:4px 0 12px }

  .tablink{
    border:1px solid var(--glass-border); background:var(--chip-bg);
    color:var(--muted); border-radius:12px; padding:12px 14px;
    text-decoration:none; font-weight:800; font-size:16px; display:block; margin-bottom:10px;
  }
  .tablink.active{
    color:var(--accent);
    outline:1px solid color-mix(in oklab, var(--accent) 28%, transparent);
    background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.80));
  }
  [data-theme="dark"] .tablink.active{
    background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  }

  /* Fallback per JS wird zusätzlich gesetzt – dennoch Media Query behalten */
  @media (max-width:860px){
    .tabs .left{ display:none }
    .app-title{ display:block }
    .hamburger{ display:flex }
  }

  .wrap{padding:16px; max-width:1920px; margin:0 auto}

  /* ===== Cards ===== */
  .cards{ display:grid; gap:14px; grid-template-columns:1fr }
  @media (min-width:1000px){ .cards{ grid-template-columns:1fr 1fr } }
  @media (min-width:1440px){ .cards{ grid-template-columns:1fr 1fr 1fr } }
  @media (min-width:1800px){ .cards{ grid-template-columns:1fr 1fr 1fr 1fr } }

  .card{
    border-radius:var(--radius);
    padding:16px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow);
  }
  .card .row{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; min-width:0 }
  .time{ font-variant-numeric:tabular-nums; font-weight:900; font-size:20px }
  .sep{ color:var(--muted) }
  .chip{
    display:inline-flex; gap:8px; align-items:center;
    background:var(--chip-bg); border:1px solid var(--chip-border);
    border-radius:12px; padding:6px 12px; font-weight:800; font-size:14px; color:var(--text);
    min-width:0; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .sub{ margin-top:8px; color:var(--muted); font-size:14px }

  /* Timeline */
  .timeline{
    margin-top:10px; border-radius:12px; padding:10px 12px;
    display:grid; grid-template-columns:22px minmax(0,1fr) auto; gap:8px 12px;
    background: var(--glass-inner); border: 1px solid var(--glass-border); box-shadow: var(--shadow);
    position:relative;
  }
  .timeline.shelf::before{ height:16px }
  .tl-ico{ text-align:center; color:var(--muted) }
  .tl-stop{ font-weight:800; min-width:0; overflow:hidden; text-overflow:ellipsis; }
  .tl-meta{ color:var(--muted); font-variant-numeric:tabular-nums; white-space:nowrap }
  .actual{ font-weight:900 }
  .planned{ font-size:12px; opacity:.80; margin-left:6px }
  .late .actual{ color:var(--bad) }
  .early .actual{ color:var(--ok) }

  /* ===== Tabellen ===== */
  .panel-table{
    border-radius:var(--radius);
    overflow:hidden;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow);
  }
  .table-head{
    position:sticky; top:0; z-index:1;
    display:grid; grid-template-columns:140px 140px 220px 1fr 120px 100px;
    padding:12px 16px; font-weight:900; color:var(--muted);
    border-bottom:1px solid var(--glass-border);
    background: var(--glass-bg);
    backdrop-filter: blur(18px) saturate(180%);
    -webkit-backdrop-filter: blur(18px) saturate(180%);
  }
  @media (max-width:740px){
    .table-head{ grid-template-columns:120px minmax(0,1fr) 100px 90px; }
    .col-plan, .col-steig { display:none }
  }
  .rows{ margin:0; background: transparent }
  .row-item{
    display:grid; grid-template-columns:140px 140px 220px 1fr 120px 100px;
    padding:14px 16px; border-bottom:1px solid var(--rule);
    background: transparent;
  }
  @media (max-width:740px){
    .row-item{ grid-template-columns:120px minmax(0,1fr) 100px 90px; }
  }
  .delta{ font-variant-numeric:tabular-nums; font-weight:900 }
  .delta.late{ color:var(--bad) } .delta.early{ color:var(--ok) } .delta.ontime{ color:var(--muted) }

  .hint{padding:12px 14px; color:var(--muted)}

  .footer{
    margin:16px 0 0; padding:10px 14px; color:var(--muted); font-size:13px;
    border-radius:12px;
    background: var(--glass-bg); border:1px solid var(--glass-border); box-shadow: var(--shadow);
  }
  .footer-space{ height:64px }

  /* ===== Skeleton / Shimmer ===== */
  @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
  .sk{
    background: linear-gradient(90deg,
      rgba(255,255,255,.28) 0%,
      rgba(255,255,255,.60) 50%,
      rgba(255,255,255,.28) 100%);
    background-size:200% 100%;
    animation: shimmer 1.1s linear infinite;
    border-radius:12px;
  }
  [data-theme="dark"] .sk{
    background: linear-gradient(90deg,
      rgba(255,255,255,.10) 0%,
      rgba(255,255,255,.20) 50%,
      rgba(255,255,255,.10) 100%);
  }
  @media (prefers-reduced-motion:reduce){ .sk{animation:none} }
  .sk-line{ height:12px; margin:8px 0 }
  .sk-line.lg{ height:18px }
  .sk-chip{ height:28px; width:120px; border-radius:12px; margin:6px 8px 6px 0 }
  .sk-row{ display:flex; flex-wrap:wrap; align-items:center; gap:8px }
  .sk-timeline{ height:56px; border-radius:12px; margin-top:10px }

</style>
</head>
<body>

  <!-- Topbar -->
  <div class="tabs shelf" role="navigation" aria-label="Navigation">
    <button id="navToggle" class="hamburger" aria-label="Menü öffnen">
      <i class="fa-solid fa-bars"></i>
    </button>
    <div class="app-title">Digitaler Fahrplan</div>

    <!-- Desktop Tabs -->
    <div class="left" aria-hidden="false">
      <a href="#route-a" class="tab active" data-key="route-a">Gießen → Frankfurt(Main) Hbf</a>
      <a href="#route-b" class="tab" data-key="route-b">Frankfurt(Main) Hbf → Gießen</a>
      <a href="#abfahrten" class="tab" data-key="abfahrten">Abfahrten (stadt­einwärts)</a>
      <a href="#homebound" class="tab" data-key="homebound">Abfahrten (heimwärts)</a>
    </div>

    <div class="spacer"></div>

    <!-- Theme Switch -->
    <button id="themeBtn" class="theme-btn" aria-label="Theme umschalten">
      <i class="fa-solid fa-sun" id="sunIcon" aria-hidden="true"></i>
      <i class="fa-solid fa-moon" id="moonIcon" style="display:none" aria-hidden="true"></i>
    </button>
  </div>

  <!-- Drawer Menu (mobil) -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <nav class="drawer-panel shelf" aria-label="Menü">
      <div class="drawer-title">Menü</div>
      <a href="#route-a" class="tablink active" data-key="route-a">Gießen → Frankfurt(Main) Hbf</a>
      <a href="#route-b" class="tablink" data-key="route-b">Frankfurt(Main) Hbf → Gießen</a>
      <a href="#abfahrten" class="tablink" data-key="abfahrten">Abfahrten (stadt­einwärts)</a>
      <a href="#homebound" class="tablink" data-key="homebound">Abfahrten (heimwärts)</a>
    </nav>
  </div>

  <div class="wrap">

    <!-- ROUTEN -->
    <div id="view-route" hidden>
      <div id="cards" class="cards"></div>
      <!-- Sentinel für Infinite Scroll -->
      <div id="sentinel" style="height:1px"></div>
      <div id="noJourneys" class="hint" style="display:none">Keine Verbindungen gefunden.</div>
    </div>

    <!-- ABFAHRTEN STADTEINWÄRTS -->
    <div id="view-abfahrten" class="panel-table shelf" hidden>
      <div class="table-head shelf">
        <div><i class="fa-regular fa-clock"></i> Abfahrt</div>
        <div class="col-plan"><i class="fa-regular fa-calendar"></i> Plan</div>
        <div><i class="fa-solid fa-route"></i> Linie</div>
        <div><i class="fa-solid fa-location-dot"></i> Ziel</div>
        <div class="col-steig"><i class="fa-solid fa-signs-post"></i> Steig</div>
        <div><i class="fa-solid fa-clock-rotate-left"></i> ±</div>
      </div>
      <div id="rows" class="rows"></div>
    </div>

    <!-- ABFAHRTEN HEIMWÄRTS -->
    <div id="view-homebound" class="panel-table shelf" hidden>
      <div class="table-head shelf">
        <div><i class="fa-regular fa-clock"></i> Abfahrt</div>
        <div class="col-plan"><i class="fa-regular fa-calendar"></i> Plan</div>
        <div><i class="fa-solid fa-location-dot"></i> Abfahrts­halt</div>
        <div><i class="fa-solid fa-route"></i> Linie</div>
        <div class="col-steig"><i class="fa-solid fa-signs-post"></i> Steig</div>
        <div><i class="fa-solid fa-clock-rotate-left"></i> ±</div>
      </div>
      <div id="rows-home" class="rows"></div>
    </div>

    <div class="footer shelf">
      <span id="refreshInfo">Aktualisierung: —</span>
      <span style="margin:0 8px; opacity:.6">•</span>
      <span id="lastUpdated">Zuletzt: —</span>
    </div>
    <div class="footer-space"></div>
  </div>

<script>
/* ========= Config ========= */
const API='https://v6.db.transport.rest';
const Q_SCHOOL='Sophie-Scholl-Schule Gießen', Q_FFMHBF='Frankfurt(Main) Hbf', Q_FRIEDR='Friedrichstraße Gießen', Q_GIESSEN='Gießen Bahnhof';

const REFRESH_ROUTE_MS=60000, REFRESH_DEPS_MS=30000;
const EXCLUDE_DIRECTIONS=[/rödgen/i,/coleman\s*str/i];

let ids={school:null,ffm:null,friedr:null,giessenBhf:null};
let activeTab='route-a', timer=null, lastUpdated=null;

/* Infinite Scroll State */
let visiblePages = 1;          // tatsächlich sichtbare Seiten (streng für 4/6/6/8)
let journeysCache = [];        // letzter Fetch (kann größer sein = Prefetch)
let currentAToB = true;        // aktuell gerenderte Richtung
let io = null;                 // IntersectionObserver

/* ========= Theme ========= */
const mediaDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
const sunIcon=document.getElementById('sunIcon'),
      moonIcon=document.getElementById('moonIcon'),
      themeBtn=document.getElementById('themeBtn');

function applyTheme(m){
  document.documentElement.setAttribute('data-theme',m);
  if(m==='dark'){ sunIcon.style.display='none'; moonIcon.style.display='inline-block'; }
  else { moonIcon.style.display='none'; sunIcon.style.display='inline-block'; }
}
applyTheme(mediaDark?.matches?'dark':'light');
mediaDark?.addEventListener?.('change',e=>applyTheme(e.matches?'dark':'light'));
themeBtn.addEventListener('click',()=>applyTheme((document.documentElement.getAttribute('data-theme')==='light')?'dark':'light'));

/* ========= Drawer (Mobil) ========= */
const drawer=document.getElementById('drawer');
const navToggle=document.getElementById('navToggle');
const drawerBackdrop=document.getElementById('drawerBackdrop');
const openDrawer=()=>{drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false')};
const closeDrawer=()=>{drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true')};
navToggle.addEventListener('click', openDrawer);
drawerBackdrop.addEventListener('click', closeDrawer);

/* ========= Topbar Fallback (iOS Safari Bugfix) ========= */
function syncTopbarForWidth(){
  const isMobile = window.innerWidth <= 860;
  const left = document.querySelector('.tabs .left');
  const burger = document.querySelector('.hamburger');
  const title = document.querySelector('.app-title');
  if(left){ left.style.display = isMobile ? 'none' : 'flex'; }
  if(burger){ burger.style.display = isMobile ? 'flex' : 'none'; }
  if(title){ title.style.display = isMobile ? 'block' : 'none'; }
}
syncTopbarForWidth();
window.addEventListener('resize', syncTopbarForWidth);

/* ========= Helpers ========= */
const fmtHM = d => new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
const fmtHMS= d => new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
function isoDurToHuman(iso,dep,arr){
  if(iso){ const h=(iso.match(/(\d+)H/)||[])[1]|0, m=(iso.match(/(\d+)M/)||[])[1]|0; return (h?`${h} h `:'')+String(m).padStart(2,'0')+' min'; }
  if(dep&&arr){ const diff=Math.max(0,Math.round((new Date(arr)-new Date(dep))/60000)); const h=Math.floor(diff/60), m=diff%60; return (h?`${h} h `:'')+String(m).padStart(2,'0')+' min'; }
  return '–';
}
function setFooter(ms){
  document.getElementById('refreshInfo').textContent='Aktualisierung: alle '+Math.round(ms/1000)+' s';
  document.getElementById('lastUpdated').textContent='Zuletzt: '+(lastUpdated?fmtHMS(lastUpdated):'—');
}

/* Parallele Fetch-Steuerung in Gruppen */
const inflight = new Map();
async function fetchJSON(url, {group='global'}={}){
  const prev=inflight.get(group);
  if(prev) prev.abort?.();
  const ctrl=new AbortController();
  inflight.set(group, ctrl);
  const r=await fetch(url,{signal:ctrl.signal});
  if(!r.ok) throw new Error(`${url} → ${r.status}`);
  lastUpdated=Date.now(); setFooter((activeTab==='abfahrten'||activeTab==='homebound')?REFRESH_DEPS_MS:REFRESH_ROUTE_MS);
  return r.json();
}

async function findStopId(q,rx){
  const data=await fetchJSON(`${API}/locations?query=${encodeURIComponent(q)}&results=10&stops=true`,{group:'lookup'});
  if(rx){const hit=data.find(x=>(x.type==='stop'||x.type==='station') && rx.test((x.name||'')+' '+(x.address?.city||''))); if(hit) return hit.id}
  const first=data.find(x=>x.type==='stop'||x.type==='station'); return first?.id||null;
}

/* ========= Linienfarben / Icons ========= */
const FIXED_COLORS={'Bus 1':'#3498db','1':'#3498db','Bus 17':'#e67e22','17':'#e67e22','RB40':'#9b59b6','RB41':'#1abc9c','RE30':'#2ecc71','S6':'#6c5ce7','ICE':'#2c3e50','IC':'#34495e'};
const HUES=[168,145,204,282,48,28,6,210,320,260,100,36,14,190,230,75];
function hashLine(s){let h=0; for(const ch of String(s)) h=((h<<5)-h)+ch.charCodeAt(0),h|=0; return Math.abs(h)}
function lineColor(name){ if(!name) return '#7f8c8d'; const key=String(name).trim(); if(FIXED_COLORS[key]) return FIXED_COLORS[key]; const norm=key.replace(/\s+Richtung.*/i,'').trim(); if(FIXED_COLORS[norm]) return FIXED_COLORS[norm]; const hue=HUES[hashLine(key)%HUES.length]; const dark=(document.documentElement.getAttribute('data-theme')==='dark'); return `hsl(${hue} 78% ${dark?72:28}%)` }
function iconForProduct(p,m){p=(p||'').toLowerCase(); m=(m||'').toLowerCase(); if(p.includes('bus')||m==='bus')return'<i class="fa-solid fa-bus"></i>'; if(p.includes('suburban')||p.includes('s-bahn')||m==='subway')return'<i class="fa-solid fa-train-subway"></i>'; if(p.includes('tram'))return'<i class="fa-solid fa-train-tram"></i>'; return'<i class="fa-solid fa-train"></i>';}
function prettyStop(n){return n==='Gießen'?'Gießen Bahnhof':n}

/* ========= Skeleton Renderer ========= */
function renderRouteSkeleton(count){
  const cards=document.getElementById('cards');
  cards.innerHTML = '';
  for(let i=0;i<count;i++){
    const sk=document.createElement('div');
    sk.className='card shelf';
    sk.innerHTML = `
      <div class="sk-row">
        <div class="sk-line lg sk" style="width:120px"></div>
        <div class="sk-line lg sk" style="width:24px"></div>
        <div class="sk-line lg sk" style="width:120px"></div>
        <div class="sk-chip sk"></div>
        <div class="sk-chip sk"></div>
      </div>
      <div class="sk-row" style="margin-top:8px">
        <div class="sk-chip sk"></div>
        <div class="sk-chip sk"></div>
        <div class="sk-chip sk" style="width:80px"></div>
      </div>
      <div class="sk-timeline sk"></div>
      <div class="sk-line sk" style="width:40%; margin-top:10px"></div>
    `;
    cards.appendChild(sk);
  }
}
function appendRouteSkeleton(count){
  const cards=document.getElementById('cards');
  for(let i=0;i<count;i++){
    const sk=document.createElement('div');
    sk.className='card shelf _skPlaceholder';
    sk.innerHTML = `
      <div class="sk-row">
        <div class="sk-line lg sk" style="width:120px"></div>
        <div class="sk-line lg sk" style="width:24px"></div>
        <div class="sk-line lg sk" style="width:120px"></div>
        <div class="sk-chip sk"></div>
        <div class="sk-chip sk"></div>
      </div>
      <div class="sk-row" style="margin-top:8px">
        <div class="sk-chip sk"></div>
        <div class="sk-chip sk"></div>
      </div>
      <div class="sk-timeline sk"></div>
    `;
    cards.appendChild(sk);
  }
}

/* ========= Timeline (geplante Zeit nur wenn abweichend) ========= */
function buildTimeline(legs){
  if(!legs?.length) return '';
  function plannedIfDiff(actual, planned){
    if(!actual || !planned) return '';
    const a=new Date(actual), p=new Date(planned);
    const diffMin=Math.round((a-p)/60000);
    return diffMin!==0 ? ` <span class="planned">(${fmtHM(planned)})</span>` : '';
  }
  const fmt=v=>v?fmtHM(v):'—';
  const cls=(a,p)=>{ if(!a||!p) return ''; const m=Math.round((new Date(a)-new Date(p))/60000); return m>0?'late':(m<0?'early':'') };
  const ico=n=> n.type==='start' ? iconForProduct(n.product,'') :
              n.type==='end'   ? '<i class="fa-solid fa-flag-checkered"></i>' :
              (!n.dep||!n.arr) ? '<i class="fa-solid fa-location-dot"></i>' :
              (/walk/i.test(n.product)?'<i class="fa-solid fa-person-walking"></i>':(/bus/i.test(n.product)?'<i class="fa-solid fa-bus"></i>':'<i class="fa-solid fa-train"></i>'));

  const nodes=[];
  nodes.push({type:'start',name:prettyStop(legs[0]?.origin?.name||'—'),dep:legs[0]?.departure||null,pdep:legs[0]?.plannedDeparture||null,product:legs[0]?.line?.product||legs[0]?.mode||''});
  for(let i=0;i<legs.length;i++){
    const l=legs[i], next=legs[i+1], dest=prettyStop(l.destination?.name||'—');
    const node={type:'mid',name:dest,arr:l.arrival||null,parr:l.plannedArrival||null,dep:null,pdep:null,product:(next?.line?.product||next?.mode||l?.line?.product||l?.mode||'')};
    if(next && next.origin?.name===l.destination?.name){ node.dep=next.departure||null; node.pdep=next.plannedDeparture||null; }
    nodes.push(node);
  }
  nodes[nodes.length-1].type='end';

  return nodes.map(n=>{
    let right='';
    if(n.type==='start'){
      const c=cls(n.dep,n.pdep);
      right=`<span class="${c}"><span class="actual">${fmt(n.dep)}</span>${plannedIfDiff(n.dep,n.pdep)}</span>`;
    }else if(n.type==='end'){
      const c=cls(n.arr,n.parr);
      right=`<span class="${c}"><span class="actual">${fmt(n.arr)}</span>${plannedIfDiff(n.arr,n.parr)}</span>`;
    }else{
      const c1=cls(n.arr,n.parr), c2=cls(n.dep,n.pdep);
      const wait=(n.arr&&n.dep)?Math.max(0,Math.round((new Date(n.dep)-new Date(n.arr))/60000)):null;
      const range=
        `<span class="${c1}"><span class="actual">${fmt(n.arr)}</span>${plannedIfDiff(n.arr,n.parr)}</span>
         ▸
         <span class="${c2}"><span class="actual">${fmt(n.dep)}</span>${plannedIfDiff(n.dep,n.pdep)}</span>`;
      right=`<span class="tl-meta">${range}</span>${(wait&&wait>0)?` <span class="tl-meta">• Wartezeit ${wait}′</span>`:''}`;
    }
    return `<div class="tl-ico">${ico(n)}</div><div class="tl-stop">${n.name}</div><div style="text-align:right">${right}</div>`;
  }).join('');
}

/* ========= Journeys Renderer ========= */
function renderJourneysInto(containerId, journeys, aToB){
  const wrap=document.getElementById(containerId); wrap.innerHTML='';
  if(!journeys.length){
    wrap.innerHTML=`<div class="card shelf">Keine Verbindungen gefunden.</div>`;
    return;
  }
  for(const j of journeys){
    const legs=j.legs||[]; const dep=j.departure||legs[0]?.departure; const arr=j.arrival||legs[legs.length-1]?.arrival;
    const changes=Math.max(0, legs.filter(l=>l.line).length - 1); const dur=isoDurToHuman(j.duration,dep,arr);
    let delay=0; const l0=legs.find(l=>!!l.departure); if(l0&&l0.plannedDeparture&&l0.departure) delay=Math.round((new Date(l0.departure)-new Date(l0.plannedDeparture))/60000);
    const chipDelay=(delay!==0)?`<span class="chip" style="color:${delay>0?'var(--bad)':'var(--ok)'}"><i class="fa-solid fa-clock-rotate-left"></i> ${delay>0?`+${delay}`:delay}′</span>`:'';
    const chips=legs.filter(l=>l.line).map(l=>`<span class="chip"><span style="color:${lineColor(l.line?.name||l.mode||'')}; font-weight:900">${iconForProduct(l.line?.product,l.mode)} ${l.line?.name||l.mode||''}</span></span>`).join('');

    const el=document.createElement('div'); el.className='card shelf';
    el.innerHTML=`
      <div class="row">
        <div class="time">${fmtHM(dep)}</div>
        <div class="sep">→</div>
        <div class="time">${fmtHM(arr)}</div>
        <span class="chip"><i class="fa-regular fa-clock"></i> ${dur}</span>
        <span class="chip"><i class="fa-solid fa-right-left"></i> ${changes}</span>
        ${chipDelay}
      </div>
      <div class="row" style="gap:8px; margin-top:8px">${chips || '<span class="chip"><i class="fa-solid fa-person-walking"></i> Fußweg</span>'}</div>
      <div class="timeline shelf">${buildTimeline(legs)}</div>
      <div class="sub">${aToB?'Sophie-Scholl-Schule → Frankfurt(Main) Hbf':'Frankfurt(Main) Hbf → Sophie-Scholl-Schule'}</div>
    `;
    wrap.appendChild(el);
  }
}

/* ========= Departures Renderer ========= */
function normalizeDepartures(raw){ if(Array.isArray(raw)) return raw; if(raw?.departures) return raw.departures; return [] }
function deltaClass(m){ if(m>0) return 'late'; if(m<0) return 'early'; return 'ontime' }

function renderDeparturesInto(containerId, deps, mode){
  const box=document.getElementById(containerId); box.innerHTML='';
  if(!deps.length){ box.innerHTML=`<div class="hint">Keine passenden Abfahrten.</div>`; return; }
  for(const d of deps){
    const line=d.line?.name||d.line?.id||'–';
    const dir = mode==='home' ? 'Sophie-Scholl-Schule, Gießen' : prettyStop(d.direction||d.destination||'–');
    const origin = (mode==='home') ? (d.originLabel||'–') : null;
    const pl=d.platform||d.prognosedPlatform||d.plannedPlatform||'–';
    const tPl=d.plannedWhen||d.when||d.scheduledWhen, tRt=d.prognosedWhen||d.when||null;
    let deltaTxt='–', cls='ontime'; if(tPl&&tRt){ const m=Math.round((new Date(tRt)-new Date(tPl))/60000); deltaTxt=(m>0?`+${m}`:m)+'′'; cls=deltaClass(m); }
    const color=lineColor(line);
    const row=document.createElement('div'); row.className='row-item';
    row.innerHTML = (mode==='home')
      ? `
        <div>${tRt?fmtHM(tRt):(tPl?fmtHM(tPl):'–')}</div>
        <div class="col-plan">${tPl?fmtHM(tPl):'–'}</div>
        <div>${origin}</div>
        <div><span class="chip"><span style="color:${color}; font-weight:900">${iconForProduct(d.line?.product,d.line?.mode)} ${line}</span></span></div>
        <div class="col-steig">–</div>
        <div class="delta ${cls}">${deltaTxt}</div>`
      : `
        <div>${tRt?fmtHM(tRt):(tPl?fmtHM(tPl):'–')}</div>
        <div class="col-plan">${tPl?fmtHM(tPl):'–'}</div>
        <div><span class="chip"><span style="color:${color}; font-weight:900">${iconForProduct(d.line?.product,d.line?.mode)} ${line}</span></span></div>
        <div>${dir}</div>
        <div class="col-steig">${pl}</div>
        <div class="delta ${cls}">${deltaTxt}</div>`;
    box.appendChild(row);
  }
}

/* ========= IDs ========= */
async function ensureIds(){
  if(!ids.school)     ids.school     = await findStopId(Q_SCHOOL, /(sophie|scholl).*(gie(s|ß)en)/i);
  if(!ids.ffm)        ids.ffm        = await findStopId(Q_FFMHBF, /(frankfurt).*(hbf)/i);
  if(!ids.friedr)     ids.friedr     = await findStopId(Q_FRIEDR, /(friedrichs?tra(ß|ss)e).*(gie(s|ß)en)/i);
  if(!ids.giessenBhf) ids.giessenBhf = await findStopId(Q_GIESSEN, /(gie(s|ß)en).*(bahnhof|hbf)/i);
}

/* ========= Spalten & Batch-Größe ========= */
function gridCols(){
  const w=window.innerWidth;
  if(w>=1800) return 4;
  if(w>=1440) return 3;
  if(w>=1000) return 2;
  return 1;
}
function batchSizeForCols(cols){ return cols===1 ? 4 : (cols===4 ? 8 : 6); }
function currentBatchSize(){ return batchSizeForCols(gridCols()); }

/* ======= Sichtbare Anzahl berechnen (4/6/6/8 * visiblePages) ======= */
function visibleCount(){
  const batch = currentBatchSize();
  return Math.min(journeysCache.length, visiblePages * batch);
}

/* ========= ROUTE Laden (ohne 60-Min Limit) ========= */
async function loadRoute(aToB=true, {keepVisible=false}={}){
  try{
    if(!keepVisible){
      visiblePages = 1;
      renderRouteSkeleton(currentBatchSize());
    }
    await ensureIds();
    currentAToB = aToB;
    const from=aToB?ids.school:ids.ffm, to=aToB?ids.ffm:ids.school;

    const prefetch = Math.max(50, visiblePages * currentBatchSize() * 2);
    const data=await fetchJSON(`${API}/journeys?from=${from}&to=${to}&results=${prefetch}&stopovers=true&language=de`,{group:'route'});
    journeysCache = data.journeys || [];

    renderJourneysInto('cards', journeysCache.slice(0, visibleCount()), aToB);
    document.getElementById('noJourneys').style.display = journeysCache.length ? 'none' : 'block';
    ensureSentinel();
  }catch(e){
    document.getElementById('cards').innerHTML=`<div class="card shelf">Fehler: ${e.message}</div>`;
  }
}

/* ========= Bottom-Guard (verhindert Auto-Load bei Start) ========= */
function nearBottom(){
  return (window.scrollY + window.innerHeight) >= (document.documentElement.scrollHeight - 320);
}

/* ========= Infinite Scroll ========= */
function ensureSentinel(){
  const sentinel = document.getElementById('sentinel');
  if(!sentinel) return;
  if(io) io.disconnect();
  io = new IntersectionObserver(async ([entry])=>{
    if(!entry.isIntersecting) return;
    if(!nearBottom()) return; // nur wirklich am Seitenende

    const batch = currentBatchSize();
    const wantVisible = (visiblePages+1) * batch;

    if(wantVisible <= journeysCache.length){
      visiblePages += 1;
      renderJourneysInto('cards', journeysCache.slice(0, visibleCount()), currentAToB);
    }else{
      // Prefetch mehr, aber Sichtbarkeit bleibt exakt bei visiblePages+1
      appendRouteSkeleton(batch);
      try{
        const from=currentAToB?ids.school:ids.ffm, to=currentAToB?ids.ffm:ids.school;
        const more=await fetchJSON(`${API}/journeys?from=${from}&to=${to}&results=${journeysCache.length + Math.max(50, batch*2)}&stopovers=true&language=de`,{group:'route-more'});
        journeysCache = more.journeys || journeysCache;
        visiblePages += 1;
        renderJourneysInto('cards', journeysCache.slice(0, visibleCount()), currentAToB);
      }catch(_){
        document.querySelectorAll('._skPlaceholder').forEach(n=>n.remove());
      }
    }
  }, {root:null, rootMargin:'0px', threshold:0});
  io.observe(sentinel);
}

/* ========= Abfahrten ========= */
async function loadInbound(){
  try{
    renderDeparturesSkeleton('rows', 8);
    await ensureIds();
    const deps=normalizeDepartures(await fetchJSON(`${API}/stops/${ids.school}/departures?duration=120&language=de`,{group:'inbound'}));
    const filtered=deps.filter(d=>!EXCLUDE_DIRECTIONS.some(rx=>rx.test(String(d.direction||d.destination||''))));
    renderDeparturesInto('rows', filtered, 'in');
  }catch(e){ document.getElementById('rows').innerHTML=`<div class="hint" style="color:var(--bad)">${e.message}</div>`; }
}

/* Heimwärts parallel */
async function loadHomebound(){
  try{
    renderDeparturesSkeleton('rows-home', 8);
    await ensureIds();
    const [depsBhf,depsFriedr]=await Promise.all([
      fetchJSON(`${API}/stops/${ids.giessenBhf}/departures?duration=120&language=de`,{group:'home-A'}),
      fetchJSON(`${API}/stops/${ids.friedr}/departures?duration=120&language=de`,{group:'home-B'})
    ]);
    function pick(rows, srcLabel, rxLine){
      for(const d of normalizeDepartures(rows)){
        const lineName=d.line?.name||'';
        const dir=(d.direction||d.destination||'').toLowerCase();
        if(!rxLine.test(lineName)) continue;
        if(!/sophie.*scholl.*schule/.test(dir)) continue; // Richtung Schule
        out.push({
          originLabel:srcLabel,
          line:{name:lineName, product:d.line?.product, mode:d.line?.mode},
          when:d.when||d.prognosedWhen||d.plannedWhen,
          plannedWhen:d.plannedWhen||d.when,
          prognosedWhen:d.prognosedWhen||d.when,
          platform:d.platform||d.prognosedPlatform||d.plannedPlatform||'–'
        });
      }
    }
    const out=[];
    pick(depsBhf, 'Gießen Bahnhof', /\b(17|Bus\s*17)\b/i);
    pick(depsFriedr,'Friedrichstraße, Gießen', /\b(1|Bus\s*1)\b/i);

    out.sort((a,b)=>new Date(a.when||a.plannedWhen)-new Date(b.when||b.plannedWhen));
    const unique=[], seen=new Set();
    for(const r of out){
      const k=(r.originLabel||'')+'|'+(r.line?.name||'')+'|'+(r.when||r.plannedWhen);
      if(!seen.has(k)){ seen.add(k); unique.push(r); }
    }
    renderDeparturesInto('rows-home', unique.slice(0,30), 'home');
    if(unique.length===0){
      document.getElementById('rows-home').innerHTML=`<div class="hint">Keine passenden Abfahrten in den nächsten 120 Minuten.</div>`;
    }
  }catch(e){ document.getElementById('rows-home').innerHTML=`<div class="hint" style="color:var(--bad)">${e.message}</div>`; }
}

/* ========= Tabs / Navigation ========= */
function setTabs(tab){
  activeTab=tab;

  // Routen-View neu starten
  if(tab==='route-a' || tab==='route-b'){ visiblePages = 1; window.scrollTo(0,0); }

  document.querySelectorAll('.tab').forEach(a=>{
    const act=(a.dataset.key===tab); a.classList.toggle('active',act); a.setAttribute('aria-selected',String(act));
  });
  document.querySelectorAll('.tablink').forEach(a=>{
    const act=(a.dataset.key===tab); a.classList.toggle('active',act); a.setAttribute('aria-selected',String(act));
  });

  document.getElementById('view-route').hidden=!(tab==='route-a'||tab==='route-b');
  document.getElementById('view-abfahrten').hidden=(tab!=='abfahrten');
  document.getElementById('view-homebound').hidden=(tab!=='homebound');
}

function startRefresh(){
  if(timer) clearInterval(timer);
  if(activeTab==='abfahrten'){ setFooter(REFRESH_DEPS_MS); loadInbound();  timer=setInterval(loadInbound,REFRESH_DEPS_MS); }
  else if(activeTab==='homebound'){ setFooter(REFRESH_DEPS_MS); loadHomebound(); timer=setInterval(loadHomebound,REFRESH_DEPS_MS); }
  else { const aToB=(activeTab==='route-a'); setFooter(REFRESH_ROUTE_MS); loadRoute(aToB); timer=setInterval(()=>loadRoute(aToB,{keepVisible:true}), REFRESH_ROUTE_MS); }
}

function handleHash(){
  const h=(location.hash||'#route-a').replace('#','');
  const ok=['route-a','route-b','abfahrten','homebound'];
  const key=ok.includes(h)?h:'route-a';
  setTabs(key);
  startRefresh();
}
window.addEventListener('hashchange',handleHash);

function navigateTo(hash){
  if(location.hash!==hash){ history.replaceState(null,'',hash); }
  closeDrawer();
  handleHash();
}

/* Clicks für beide Nav-Varianten */
document.addEventListener('click',(e)=>{
  const a=e.target.closest('a.tab, a.tablink');
  if(!a) return;
  const href=a.getAttribute('href'); if(!href || !href.startsWith('#')) return;
  e.preventDefault();
  navigateTo(href);
});

/* ========= Resize: sichtbare Anzahl je Spalten-Layout anpassen ========= */
window.addEventListener('resize', ()=>{
  if(!(activeTab==='route-a'||activeTab==='route-b')) return;
  renderJourneysInto('cards', journeysCache.slice(0, visibleCount()), currentAToB);
});

/* ========= Departures Skeleton helper ========= */
function renderDeparturesSkeleton(containerId, rows=8){
  const box=document.getElementById(containerId);
  box.innerHTML='';
  for(let i=0;i<rows;i++){
    const r=document.createElement('div');
    r.className='row-item';
    r.innerHTML = `
      <div class="sk sk-line" style="width:70px"></div>
      <div class="col-plan"><div class="sk sk-line" style="width:70px"></div></div>
      <div><div class="sk sk-line" style="width:110px"></div></div>
      <div><div class="sk sk-line" style="width:60%"></div></div>
      <div class="col-steig"><div class="sk sk-line" style="width:40px"></div></div>
      <div class="sk sk-line" style="width:40px"></div>
    `;
    box.appendChild(r);
  }
}

/* ========= Init ========= */
(function init(){ handleHash(); syncTopbarForWidth(); })();
</script>
</body>
</html>
