<!doctype html>
<html lang="de" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Digitaler Fahrplan</title>

<!-- Font Awesome (kostenlos, ohne Account) für Sonne/Mond + Fahrzeug-Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Digitaler Fahrplan">

<style>
  /* ========= Design-System (DB-inspiriert) ========= */
  :root{
    --accent:#ec0016;        /* DB-Rot */
    --bg:#f8f9fb;
    --panel:#ffffff;
    --text:#181c22;
    --muted:#667486;
    --rule:#e5eaf0;
    --chip:#f3f6f9;
    --shadow:0 0 0 1px rgba(0,0,0,.02), 0 10px 30px rgba(0,0,0,.08);
    --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  [data-theme="dark"]{
    --bg:#0b0f14;
    --panel:#0f1620;
    --text:#eaf2ff;
    --muted:#9aa8bd;
    --rule:#16202c;
    --chip:#111c28;
    --shadow:none;
  }

  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font-family:var(--font); -webkit-font-smoothing:antialiased;}

  /* ========= Header ========= */
  .hdr{
    position:sticky; top:0; z-index:40;
    display:flex; align-items:center; gap:16px;
    padding:16px 20px; background:var(--panel);
    border-bottom:1px solid var(--rule); box-shadow:var(--shadow);
  }
  .brand{ font-weight:800; letter-spacing:.2px; font-size:22px; }
  .spacer{ flex:1 }
  .iconbtn{
    border:1px solid var(--rule); background:var(--chip); color:var(--text);
    border-radius:12px; padding:10px 12px; display:inline-flex; align-items:center; gap:10px;
    cursor:pointer; user-select:none; font-weight:700;
  }
  .iconbtn i{ font-size:18px }
  .iconbtn:hover{ filter:brightness(.98); }

  /* ========= Tabs ========= */
  .tabs{
    display:flex; gap:10px; padding:10px 16px; overflow:auto hidden;
    background:var(--panel); border-bottom:1px solid var(--rule);
  }
  .tab{
    padding:10px 14px; border-radius:10px; white-space:nowrap; text-decoration:none;
    color:var(--muted); border:1px solid transparent; flex:0 0 auto; font-weight:800; font-size:16px;
  }
  .tab.active{ color:var(--accent); background:var(--panel); border-color:var(--rule); }

  /* ========= Content Wrapper ========= */
  .wrap{ padding:12px 16px 18px; max-width:1920px; margin:0 auto; }
  .panel{
    background:var(--panel); border:1px solid var(--rule); border-radius:14px; overflow:hidden; box-shadow:var(--shadow);
  }

  /* ========= Journeys (Routen) ========= */
  .cards{ display:grid; grid-template-columns: 1fr; }
  .card{ padding:18px; border-top:1px solid var(--rule); }
  .card:first-child{ border-top:none; }
  .row1{ display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; }
  .dep,.arr,.dur,.chg{ font-variant-numeric:tabular-nums; font-weight:800; }
  .meta{ color:var(--muted); }
  .chips{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
  .chip{
    display:inline-flex; align-items:center; gap:10px;
    background:var(--chip); border:1px solid var(--rule); border-radius:10px;
    padding:8px 12px; font-weight:800;
  }
  .chip i{ opacity:.9 }
  .sub{ margin-top:6px; color:var(--muted); }

  @media (min-width:1100px){
    .cards{ grid-template-columns: 1fr 1fr; }
    .card{ min-height:92px; }
  }

  /* ========= Abfahrten-Tabelle ========= */
  table{ width:100%; border-collapse:collapse; }
  thead th{
    text-align:left; background:var(--panel); position:sticky; top:126px; z-index:5;
    padding:14px 16px; color:var(--muted); border-bottom:1px solid var(--rule);
  }
  tbody td{
    padding:14px 16px; border-bottom:1px solid var(--rule);
  }
  .line{ font-weight:900; }
  .delta{ font-variant-numeric:tabular-nums; font-weight:800; }
  .late{ color:#b40000; }
  .early{ color:#0a8a3f; }

  .hint{ padding:10px 12px; color:var(--muted); font-size:14px; }
  .err{ color:#b40000; padding:14px 16px; }

  /* ========= Footer (klein) ========= */
  footer{
    padding:10px 16px; color:var(--muted); font-size:13px; display:flex; gap:12px; align-items:center;
  }
  footer .dot{ opacity:.5 }
</style>
</head>
<body>
  <!-- Header -->
  <div class="hdr" role="banner">
    <div class="brand">Digitaler Fahrplan</div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" aria-label="Design umschalten" title="Design umschalten">
      <i class="fa-solid fa-sun" id="sunIcon"></i>
      <i class="fa-solid fa-moon" id="moonIcon" style="display:none"></i>
      <span id="themeLabel">Hell</span>
    </button>
  </div>

  <!-- Tabs -->
  <nav class="tabs" role="tablist" aria-label="Ansichten">
    <a href="#route-a" class="tab active" role="tab" aria-selected="true" id="tab-a">Gießen → Frankfurt(Main) Hbf</a>
    <a href="#route-b" class="tab" role="tab" aria-selected="false" id="tab-b">Frankfurt(Main) Hbf → Gießen</a>
    <a href="#abfahrten" class="tab" role="tab" aria-selected="false" id="tab-c">Abfahrten (stadt­einwärts)</a>
  </nav>

  <div class="wrap">
    <div class="panel" id="panel">

      <!-- Route Cards -->
      <div id="view-route" hidden>
        <div class="hint">Nächste Verbindungen. Quelle: transport.rest (DB/HAFAS). Aktualisiert alle 60 s.</div>
        <div id="cards" class="cards">
          <div class="card meta">Lade Verbindungen …</div>
        </div>
      </div>

      <!-- Departures Table -->
      <div id="view-abfahrten" hidden>
        <div class="hint">Nur stadt­einwärts (Ziele Richtung Innenstadt/Bahnhof). „Rödgen“ und „Coleman Str.“ werden ausgeblendet. Aktualisiert alle 30 s.</div>
        <table>
          <thead>
            <tr>
              <th style="width:120px;">Abfahrt</th>
              <th style="width:120px;">Plan</th>
              <th style="width:120px;">Linie</th>
              <th>Ziel</th>
              <th style="width:120px;">Steig</th>
              <th style="width:100px;">∆</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="6" class="meta" style="padding:18px">Lade Abfahrten …</td></tr>
          </tbody>
        </table>
        <div class="err" id="depErr" hidden></div>
      </div>
    </div>
  </div>

  <footer>
    <span id="refreshInfo">Aktualisierung: —</span>
    <span class="dot">•</span>
    <span id="lastUpdated">Zuletzt: —</span>
  </footer>

<script>
/* ========= Config ========= */
const API = 'https://v6.db.transport.rest';
const Q_SCHOOL = 'Sophie-Scholl-Schule Gießen';
const Q_FFMHBF = 'Frankfurt(Main) Hbf';
const REFRESH_ROUTE_MS = 60000;  // 60 s
const REFRESH_DEPS_MS  = 30000;  // 30 s

// Stadteinwärts: bekannte Gegenrichtungen ausschließen
const EXCLUDE_DIRECTIONS = [/rödgen/i, /coleman/i];

/* ========= State ========= */
let ids = { school:null, ffm:null };
let activeTab = 'route-a';
let timer = null;
let lastUpdated = null;

/* ========= Utilities ========= */
function fmtHM(d){ return new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}); }
function fmtHMS(d){ return new Date(d).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function setFooter(infoMs){
  document.getElementById('refreshInfo').textContent = 'Aktualisierung: alle ' + Math.round(infoMs/1000) + ' s';
  document.getElementById('lastUpdated').textContent = 'Zuletzt: ' + (lastUpdated ? fmtHMS(lastUpdated) : '—');
}
async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(`${url} → ${r.status}`);
  lastUpdated = Date.now();
  setFooter(activeTab==='abfahrten' ? REFRESH_DEPS_MS : REFRESH_ROUTE_MS);
  return r.json();
}
async function findStopId(query){
  const url = `${API}/locations?query=${encodeURIComponent(query)}&results=8&stops=true`;
  const data = await fetchJSON(url);
  const first = data.find(x => x.type==='stop' || x.type==='station');
  return first?.id || null;
}

/* ========= Theme ========= */
function setTheme(mode){
  document.documentElement.setAttribute('data-theme', mode);
  localStorage.setItem('fahrplan-theme', mode);
  const sun = document.getElementById('sunIcon');
  const moon= document.getElementById('moonIcon');
  const lab = document.getElementById('themeLabel');
  if(mode==='dark'){ sun.style.display='none'; moon.style.display='inline-block'; lab.textContent='Dunkel'; }
  else { moon.style.display='none'; sun.style.display='inline-block'; lab.textContent='Hell'; }
}
document.getElementById('themeBtn').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'light';
  setTheme(cur==='light' ? 'dark':'light');
});
setTheme(localStorage.getItem('fahrplan-theme') || 'light');

/* ========= Icon Mapper ========= */
function iconForProduct(product, mode){
  const p = (product||'').toLowerCase();
  const m = (mode||'').toLowerCase();
  if(p.includes('bus') || m==='bus') return '<i class="fa-solid fa-bus"></i>';
  if(p.includes('suburban') || p.includes('s-bahn') || m==='subway') return '<i class="fa-solid fa-train-subway"></i>';
  if(p.includes('tram')) return '<i class="fa-solid fa-train-tram"></i>'; /* falls nicht vorhanden, nutzt FA Fallback auf square */
  return '<i class="fa-solid fa-train"></i>'; // Regional, RE/RB, IC/ICE
}

/* ========= Renderers ========= */
// Journeys
function renderJourneys(list, aToB){
  const wrap = document.getElementById('cards');
  wrap.innerHTML = '';
  if(!list?.journeys?.length){
    wrap.innerHTML = `<div class="card meta">Keine Verbindungen gefunden.</div>`;
    return;
  }
  for(const j of list.journeys.slice(0, 8)){
    const legs = (j.legs||[]);
    const dep = j.departure || legs[0]?.departure;
    const arr = j.arrival || legs[legs.length-1]?.arrival;
    const changes = Math.max(0, legs.filter(l=>l.line).length - 1);
    const dur = (j.duration||'').replace('PT','').toLowerCase();

    const chips = legs
      .filter(l => l.line) // nur echte Fahrten, keine Fußwege
      .map(l => {
        const line = l.line?.name || l.mode || '';
        const icn  = iconForProduct(l.line?.product, l.mode);
        return `<span class="chip">${icn} ${line}</span>`;
      }).join('');

    const subtitle = aToB
      ? 'Sophie-Scholl-Schule → Frankfurt(Main) Hbf'
      : 'Frankfurt(Main) Hbf → Sophie-Scholl-Schule';

    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div class="row1">
        <div class="dep">${fmtHM(dep)}</div>
        <div class="meta">→</div>
        <div class="arr">${fmtHM(arr)}</div>
        <div class="meta">•</div>
        <div class="dur">${dur}</div>
        <div class="meta">• Umstiege:</div>
        <div class="chg">${changes}</div>
      </div>
      <div class="chips">${chips || '<span class="chip"><i class="fa-solid fa-person-walking"></i> Fußweg</span>'}</div>
      <div class="sub">${subtitle}</div>
    `;
    wrap.appendChild(el);
  }
}

// Departures (stadt­einwärts)
function renderDepartures(deps){
  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';
  const filtered = (deps||[]).filter(d=>{
    const dir = (d.direction || d.destination || '').toString();
    return !EXCLUDE_DIRECTIONS.some(rx => rx.test(dir));
  });
  if(filtered.length===0){
    tbody.innerHTML = `<tr><td colspan="6" class="meta" style="padding:18px">Keine passenden Abfahrten.</td></tr>`;
    return;
  }
  for(const d of filtered){
    const line = d.line?.name || d.line?.id || '–';
    const dir = d.direction || d.destination || '–';
    const pl  = d.platform || d.prognosedPlatform || d.plannedPlatform || '–';
    const tPl = d.plannedWhen || d.when || d.scheduledWhen;
    const tRt = d.prognosedWhen || d.when || null;
    let delta = '–', cls='';
    if(tPl && tRt){
      const m = Math.round((new Date(tRt) - new Date(tPl))/60000);
      delta = (m>0? '+'+m: m) + '′';
      if(m>=2) cls='late'; else if(m<=-2) cls='early';
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${tRt ? fmtHM(tRt) : (tPl?fmtHM(tPl):'–')}</td>
      <td>${tPl ? fmtHM(tPl) : '–'}</td>
      <td class="line">${line}</td>
      <td>${dir}</td>
      <td>${pl}</td>
      <td class="delta ${cls}">${delta}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ========= Loaders ========= */
async function ensureIds(){
  if(!ids.school) ids.school = await findStopId(Q_SCHOOL);
  if(!ids.ffm)    ids.ffm    = await findStopId(Q_FFMHBF);
}

async function loadRoute(aToB=true){
  try{
    await ensureIds();
    const from = aToB ? ids.school : ids.ffm;
    const to   = aToB ? ids.ffm    : ids.school;
    if(!from || !to) throw new Error('Haltestellen nicht gefunden.');
    const url = `${API}/journeys?from=${from}&to=${to}&results=8&stopovers=false&language=de`;
    const data = await fetchJSON(url);
    renderJourneys(data, aToB);
  }catch(e){
    document.getElementById('cards').innerHTML = `<div class="card err">${e.message}</div>`;
  }
}

async function loadDepartures(){
  try{
    await ensureIds();
    const url = `${API}/stops/${ids.school}/departures?duration=90&language=de`;
    const deps = await fetchJSON(url);
    renderDepartures(deps);
    document.getElementById('depErr').hidden = true;
  }catch(e){
    document.getElementById('depErr').hidden = false;
    document.getElementById('depErr').textContent = e.message;
  }
}

/* ========= Tabs & Intervals ========= */
function setTabs(tab){
  activeTab = tab;
  for(const a of document.querySelectorAll('.tab')){
    const act = a.getAttribute('href') === '#'+tab;
    a.classList.toggle('active', act);
    a.setAttribute('aria-selected', String(act));
  }
  const viewRoute = document.getElementById('view-route');
  const viewDeps  = document.getElementById('view-abfahrten');
  if(tab === 'abfahrten'){ viewRoute.hidden = true; viewDeps.hidden = false; }
  else { viewRoute.hidden = false; viewDeps.hidden = true; }
}

function startRefresh(){
  if(timer) clearInterval(timer);
  if(activeTab==='abfahrten'){
    setFooter(REFRESH_DEPS_MS);
    loadDepartures();
    timer = setInterval(loadDepartures, REFRESH_DEPS_MS);
  }else{
    const aToB = activeTab==='route-a';
    setFooter(REFRESH_ROUTE_MS);
    loadRoute(aToB);
    timer = setInterval(()=>loadRoute(aToB), REFRESH_ROUTE_MS);
  }
}

function handleHash(){
  const hash = (location.hash || '#route-a').replace('#','');
  const allowed = ['route-a','route-b','abfahrten'];
  setTabs(allowed.includes(hash) ? hash : 'route-a');
  startRefresh();
}
window.addEventListener('hashchange', handleHash);

// Tab clicks (verhindert Scroll-Jump auf iOS)
for(const a of document.querySelectorAll('.tab')){
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    const h = a.getAttribute('href');
    history.replaceState(null,'',h);
    handleHash();
  });
}

/* ========= Init ========= */
(function init(){
  handleHash();
})();
</script>
</body>
</html>
